# 热交换器性能监测系统需求文档

## 1. 项目概述

热交换器性能监测系统是一个用于实时监测和评估热交换器运行性能的自动化系统。该系统通过采集运行参数、计算物理参数和传热系数，实现对热交换器性能的在线监测、预测和分析。

## 2. 核心组件

### 2.1 后端计算模块 (backend/)

后端计算模块是系统的核心，负责数据处理、参数计算和模型训练。

#### 2.1.1 主要类和功能

**MainCalculator 类** (`backend/calculation/main_calculator.py`)
- 作为系统的主控制器，协调各个计算模块
- 实现分阶段训练策略（阶段1：基础参数确定，阶段2：参数精优化）
- 处理数据流程：读取运行参数 → 计算物理参数 → 计算传热系数 → 预测性能
- 管理数据库连接和数据加载

**NonlinearRegressionCalculator 类** (`backend/calculation/nonlinear_regression.py`)
- 实现基于非线性回归的传热系数优化算法
- 模型函数：Y = a * x^(-p) + b（其中Y=1/K，x=Re）
- 支持自适应优化策略（conservative/aggressive/dynamic）
- 提供参数优化和性能预测功能

**LMTDCalculator 类** (`backend/calculation/lmtd_calculator.py`)
- 计算对数平均温差（LMTD）
- 计算基于LMTD的传热系数（K_lmtd）

**DataLoader 类** (`backend/db/data_loader.py`)
- 负责从数据库读取和写入数据
- 提供数据处理和转换功能

**DatabaseConnection 类** (`backend/db/db_connection.py`)
- 管理数据库连接（测试数据库和生产数据库）
- 提供数据库操作接口

### 2.2 自动化数据处理脚本 (`script/auto_data_processing.py`)

自动化数据处理脚本是系统的入口点，负责定时执行数据处理流程。

#### 2.2.1 主要功能

1. **定时任务调度**
   - 每间隔0.5分钟执行一次数据处理流程
   - 模拟时间增加，按小时处理数据

2. **数据处理流程**
   - 读取指定天数和小时的运行参数
   - 调用MainCalculator执行数据处理
   - 调用API获取性能数据
   - 将结果保存到文件

3. **错误处理和日志记录**
   - 实现API调用重试机制
   - 详细记录操作日志
   - 处理异常情况

## 3. 计算逻辑

### 3.1 整体计算逻辑

系统的整体计算逻辑基于 `trying-code/calculate-wilosn-reserve/main_points.py`，主要包括：

1. **分points训练策略**
   - 为每个监测点（points）创建独立的模型
   - 针对不同points分别进行参数训练和优化

2. **两阶段训练流程**
   - **阶段1（基础参数确定）**：使用前20天数据进行初始拟合，确定基础参数
   - **阶段2（参数精优化）**：从第21天开始，使用新数据和历史数据进行参数优化

3. **动态参数调整**
   - 根据历史误差情况选择自适应策略
   - 误差较大时使用保守策略，误差较小时使用激进策略
   - 支持参数重新训练机制

### 3.2 非线性回归计算方法

非线性回归方法基于 `trying-code/calculate-wilosn-reserve/heat_transfer_calculator.py` 中的 `NonlinearRegressionCalculator` 类，主要包括：

1. **模型函数**：
   ```
   Y = a * x^(-p) + b
   其中：Y = 1/K（K为传热系数），x = Re（雷诺数）
   ```

2. **损失函数**：
   - 结合R²优化目标和相对误差
   - 主要优化R²，同时控制相对误差
   - 计算公式：`combined_loss = 0.7 * r2_loss + 0.3 * relative_error_normalized`

3. **优化策略**：
   - 使用L-BFGS-B方法进行参数优化
   - 支持数据标准化，提高优化稳定性
   - 根据阶段和自适应策略调整参数范围

## 4. 配置管理

系统使用JSON配置文件进行参数管理，主要包括：

### 4.1 脚本配置 (`script/config.json`)

```json
{
    "api_url": "http://localhost:8000",          // API服务地址
    "api_timeout": 30,                           // API超时时间
    "interval_minutes": 0.5,                     // 数据处理间隔（分钟）
    "start_day": 1,                              // 开始处理的天数
    "start_hour": 0,                             // 开始处理的小时
    "total_hours": 24,                           // 总处理小时数
    "output_dir": "../output",                  // 输出目录
    "output_format": "txt",                     // 输出格式
    "database": {                                // 数据库配置
        "test": { ... },                         // 测试数据库
        "production": { ... }                    // 生产数据库
    }
}
```

### 4.2 后端配置 (`backend/config/config.json`)

```json
{
    "data_directory": "./data",                 // 数据目录
    "result_directory": "./result",             // 结果目录
    "training_days": 20,                         // 阶段1训练天数
    "max_days": 800,                             // 最大处理天数
    "history_days": 3,                           // 阶段2优化使用的历史天数
    "optimization_hours": 3,                     // 每天用于优化的小时数
    "stage1_error_threshold": 5,                 // 触发重新训练的误差阈值
    "stage1_history_days": 5,                    // 重新训练使用的历史天数
    "algorithms": ["wilsonOld", "nonlinear"],  // 支持的算法
    "selected_algorithm": "nonlinear",          // 选择的算法
    "database": { ... }                          // 数据库配置
}
```

## 5. 数据库设计

系统使用MySQL数据库存储数据，分为测试数据库和生产数据库：

### 5.1 主要表结构

1. **heat_exchangers**：换热器基本信息
2. **operation_parameters**：运行参数（温度、压力、流速等）
3. **physical_parameters**：物理参数（密度、粘度、比热容等）
4. **performance_parameters**：性能参数（传热系数、热负荷等）
5. **model_parameters**：模型参数（非线性回归模型的a、p、b值）
6. **k_management**：传热系数管理（实际值、预测值、LMTD值等）

### 5.2 数据流程

1. 从测试数据库读取运行参数
2. 计算物理参数并插入生产数据库
3. 计算传热系数并插入生产数据库
4. 训练模型参数并插入生产数据库
5. API查询生产数据库获取性能数据

## 6. 运行流程

### 6.1 系统启动流程

1. 加载配置文件
2. 初始化数据库连接
3. 初始化MainCalculator
4. 执行初始数据处理
5. 设置定时任务

### 6.2 数据处理流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                            数据处理流程                                  │
└─────────────────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────┐
│ 1. 读取运行参数数据     │
└─────────────────────────┘
        │
        ▼
┌─────────────────────────┐
│ 2. 计算物理参数         │
│    (雷诺数、普朗特数等) │
└─────────────────────────┘
        │
        ▼
┌─────────────────────────┐
│ 3. 计算LMTD             │
│    (对数平均温差)       │
└─────────────────────────┘
        │
        ▼
┌─────────────────────────┐
│ 4. 计算K_lmtd           │
│    (基于LMTD的传热系数) │
└─────────────────────────┘
        │
        ▼
┌─────────────────────────┐
│ 5. 模型训练/优化        │
│    (阶段1或阶段2)       │
└─────────────────────────┘
        │
        ▼
┌─────────────────────────┐
│ 6. 预测K_predicted      │
│    (预测传热系数)       │
└─────────────────────────┘
        │
        ▼
┌─────────────────────────┐
│ 7. 保存结果到数据库     │
└─────────────────────────┘
        │
        ▼
┌─────────────────────────┐
│ 8. API获取性能数据      │
└─────────────────────────┘
        │
        ▼
┌─────────────────────────┐
│ 9. 保存结果到文件       │
└─────────────────────────┘
```

## 7. 系统特点

### 7.1 分阶段训练策略

1. **阶段1（基础参数确定）**
   - 使用前20天数据进行初始拟合
   - 确定模型的基础参数（a、p、b）
   - 为所有监测点建立初始模型

2. **阶段2（参数精优化）**
   - 从第21天开始，使用新数据进行优化
   - 结合历史数据，采用加权方式进行参数调整
   - 支持自适应优化策略

### 7.2 自适应优化策略

- **保守策略（conservative）**：误差较大时使用，参数范围更严格
- **激进策略（aggressive）**：误差较小时使用，参数范围更宽松
- **动态策略（dynamic）**：默认策略，根据情况自动调整

### 7.3 数据完整性检查

- 对输入数据进行严格的有效性检查
- 确保计算过程中使用的参数有效
- 处理异常情况，避免无效计算结果

### 7.4 详细的日志记录

- 记录关键操作和计算过程
- 提供详细的错误信息，便于调试
- 支持日志分级，便于问题定位

## 8. 扩展和维护

### 8.1 配置扩展

- 支持通过配置文件调整训练参数
- 支持切换不同的算法
- 支持调整数据库连接参数

### 8.2 功能扩展

- 支持添加新的计算模型
- 支持扩展新的API接口
- 支持增加新的监测点

### 8.3 维护建议

- 定期备份数据库
- 监控系统运行状态
- 根据实际情况调整模型参数和优化策略
- 定期检查和更新系统配置

## 9. 总结

热交换器性能监测系统是一个自动化的性能监测和评估系统，通过采集运行参数、计算物理参数和传热系数，实现对热交换器性能的在线监测和预测。系统采用分阶段训练策略和自适应优化算法，能够准确预测热交换器的性能变化，为设备维护和优化提供依据。