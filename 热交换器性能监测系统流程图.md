# 热交换器性能监测系统详细流程图

## 系统概述

本系统是一个自动化的热交换器性能监测系统，通过定时采集和处理运行数据，计算物理参数和传热系数，实现对热交换器性能的实时监测和预测。系统采用两阶段训练策略和自适应优化算法，能够准确预测热交换器的性能变化。

## 整体系统架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        热交换器性能监测系统整体架构                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────┐   定时调度(0.5分钟)   ┌──────────────────────────────┐  │
│  │ 自动数据处理脚本  │ ────────────────────▶│  MainCalculator计算引擎      │  │
│  │ (auto_data_     │                       │  (main_calculator.py)       │  │
│  │  processing.py) │                       │  • 8步数据处理流程           │  │
│  └────────┬────────┘                       │  • 两阶段训练策略            │  │
│           │                                │  • 非线性回归优化            │  │
│           │ API调用                         └──────────┬─────────────────┘  │
│           ▼                                            │                    │
│  ┌─────────────────┐                                   │ 计算调用           │
│  │ FastAPI服务     │                                   ▼                    │
│  │ (api/main.py)   │                       ┌──────────────────────────────┐  │
│  └────────┬────────┘                       │  非线性回归计算器            │  │
│           │                                │  (nonlinear_regression.py)   │  │
│           │ 数据查询                        │  • 模型训练: Y=a*x^(-p)+b    │  │
│           ▼                                │  • 参数优化                  │  │
│  ┌─────────────────┐                       │  • K值预测                  │  │
│  │ 输出文件        │                       └──────────┬─────────────────┘  │
│  │ (output/)       │                                   │                    │
│  └─────────────────┘                                   │                    │
│                                                        ▼                    │
│                                          ┌──────────────────────────────┐  │
│                                          │  LMTD计算器                  │  │
│                                          │  (lmtd_calculator.py)        │  │
│                                          │  • 对数平均温差计算           │  │
│                                          │  • K_lmtd计算                │  │
│                                          └──────────┬─────────────────┘  │
│                                                     │                    │
│                                                     ▼                    │
│                                          ┌──────────────────────────────┐  │
│                                          │  数据库交互层                 │  │
│                                          │  (data_loader.py,            │  │
│                                          │   db_connection.py)          │  │
│                                          │  • 测试数据库读写             │  │
│                                          │  • 生产数据库读写             │  │
│                                          └──────────┬─────────────────┘  │
│                                                     │                    │
│                                          ┌──────────┴─────────────────┐  │
│                                          │          数据库              │  │
│                                          │  ┌────────────┬──────────┐  │  │
│                                          │  │ 测试数据库  │生产数据库 │  │  │
│                                          │  │ (原始数据)  │(计算结果)│  │  │
│                                          │  └────────────┴──────────┘  │  │
│                                          └──────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 详细流程图

### 1. 自动数据处理脚本流程 (`script/auto_data_processing.py`)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    自动数据处理脚本工作流程                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  开始                                                                        │
│    ↓                                                                        │
│  ┌─────────────────────────────────────────────┐                            │
│  │  1. 加载配置                                │                            │
│  │     • script/config.json                    │                            │
│  │     • backend/config/config.json            │                            │
│  └─────────────────────────────────────────────┘                            │
│    ↓                                                                        │
│  ┌─────────────────────────────────────────────┐                            │
│  │  2. 初始化计算引擎                          │                            │
│  │     • MainCalculator实例化                  │                            │
│  │     • 设置回调函数                          │                            │
│  │       - stage1_complete_callback            │                            │
│  │       - stage2_complete_callback            │                            │
│  │       - error_retrain_complete_callback     │                            │
│  └─────────────────────────────────────────────┘                            │
│    ↓                                                                        │
│  ┌─────────────────────────────────────────────┐                            │
│  │  3. 执行初始数据处理                        │                            │
│  │     • 处理第1天第0小时数据                  │                            │
│  └─────────────────────────────────────────────┘                            │
│    ↓                                                                        │
│  ┌─────────────────────────────────────────────┐                            │
│  │  4. 设置定时任务                            │                            │
│  │     • 每0.5分钟执行main_processing()        │                            │
│  └─────────────────────────────────────────────┘                            │
│    ↓                                                                        │
│  ┌─────────────────────────────────────────────┐                            │
│  │  5. main_processing()函数                   │                            │
│  │     │                                       │                            │
│  │     ├─► 模拟时间递增                        │                            │
│  │     │   当前小时+1                          │                            │
│  │     │   若超过24小时，天数+1                │                            │
│  │     │                                       │                            │
│  │     ├─► 调用calculator.process_data_by_hour()│                          │
│  │     │   传入(day, hour)参数                 │                            │
│  │     │                                       │                            │
│  │     ├─► 检查是否超过最大天数(50天)          │                            │
│  │     │   若超过则终止脚本                    │                            │
│  │     │                                       │                            │
│  │     └─► 记录处理结果                        │                            │
│  └─────────────────────────────────────────────┘                            │
│    ↓                                                                        │
│  ┌─────────────────────────────────────────────┐                            │
│  │  6. API调用和数据保存                       │                            │
│  │     • 调用API: /performance接口             │                            │
│  │     • 参数: heat_exchanger_id=1, day, hour  │                            │
│  │     • 保存结果到output/day{day}_hour{hour}.txt │                        │
│  └─────────────────────────────────────────────┘                            │
│    ↓                                                                        │
│  继续定时执行                                                                 │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2. MainCalculator 8步数据处理流程 (`backend/calculation/main_calculator.py`)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    MainCalculator.process_data_by_hour()流程                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  输入: day(天数), hour(小时)                                                │
│    ↓                                                                        │
│  ┌─────────────────────────────────────────────┐                            │
│  │  步骤1: 读取运行参数                        │                            │
│  │     • 从测试数据库读取                      │                            │
│  │     • 表: operation_parameters             │                            │
│  │     • 条件: 指定day和hour                  │                            │
│  │     • 插入到生产数据库                      │                            │
│  └─────────────────────────────────────────────┘                            │
│    ↓                                                                        │
│  ┌─────────────────────────────────────────────┐                            │
│  │  步骤2: 计算物理参数                        │                            │
│  │     • 处理所有侧的数据(tube/shell)         │                            │
│  │     • 计算: 密度、粘度、导热系数、比热容     │                            │
│  │     • 计算: 雷诺数(Re)、普朗特数(Pr)        │                            │
│  │     • 插入到生产数据库                      │                            │
│  │       - physical_parameters表              │                            │
│  └─────────────────────────────────────────────┘                            │
│    ↓                                                                        │
│  ┌─────────────────────────────────────────────┐                            │
│  │  步骤3: 读取测试数据库性能参数              │                            │
│  │     • 从测试数据库读取                      │                            │
│  │     • 表: performance_parameters           │                            │
│  │     • 获取: K_actual, alpha_o              │                            │
│  │     • 构建映射表供后续使用                  │                            │
│  └─────────────────────────────────────────────┘                            │
│    ↓                                                                        │
│  ┌─────────────────────────────────────────────┐                            │
│  │  步骤4: 计算LMTD和K_lmtd                    │                            │
│  │     │                                       │                            │
│  │     ├─► 确定热侧和冷侧                      │                            │
│  │     │   根据工质类型判断                    │                            │
│  │     │                                       │                            │
│  │     ├─► 构建温度映射表                      │                            │
│  │     │   {timestamp: {side: {points: temp}}}│                            │
│  │     │                                       │                            │
│  │     ├─► 计算热负荷(heat_duty)              │                            │
│  │     │   从测试数据获取或计算                │                            │
│  │     │                                       │                            │
│  │     ├─► 计算LMTD                           │                            │
│  │     │   使用LMTDCalculator                 │                            │
│  │     │                                       │                            │
│  │     └─► 计算K_lmtd                         │                            │
│  │        K_lmtd = Q / (A × LMTD)             │                            │
│  └─────────────────────────────────────────────┘                            │
│    ↓                                                                        │
│  ┌─────────────────────────────────────────────┐                            │
│  │  步骤5: 构建k_management和performance数据   │                            │
│  │     │                                       │                            │
│  │     ├─► 构建k_management_data              │                            │
│  │     │   - K_actual(从测试数据库)           │                            │
│  │     │   - K_LMTD(步骤4计算)                │                            │
│  │     │   - K_predicted(初始为0)             │                            │
│  │     │   - 插入到k_management表             │                            │
│  │     │                                       │                            │
│  │     └─► 构建performance_data               │                            │
│  │        - heat_duty                         │                            │
│  │        - lmtd                              │                            │
│  │        - alpha_o(从测试数据库)             │                            │
│  │        - alpha_i(初始为0)                  │                            │
│  │        - K(初始为0)                        │                            │
│  │        - 插入到performance_parameters表    │                            │
│  └─────────────────────────────────────────────┘                            │
│    ↓                                                                        │
│  ┌─────────────────────────────────────────────┐                            │
│  │  步骤6: 阶段1训练(条件触发)                 │                            │
│  │     • 触发条件:                            │                            │
│  │       - stage == 1                         │                            │
│  │       - model_params为空                   │                            │
│  │       - day == training_days(默认20)       │                            │
│  │       - hour == 23                         │                            │
│  │     • 执行操作:                            │                            │
│  │       - 获取前20天数据                     │                            │
│  │       - 训练非线性回归模型                 │                            │
│  │       - 得到参数a, p, b                    │                            │
│  │       - 插入model_parameters表             │                            │
│  │       - stage = 2                          │                            │
│  │       - 重新处理历史数据(第1-20天)         │                            │
│  │       - 调用stage1_complete_callback       │                            │
│  └─────────────────────────────────────────────┘                            │
│    ↓                                                                        │
│  ┌─────────────────────────────────────────────┐                            │
│  │  步骤7: 计算K_predicted和alpha_i            │                            │
│  │     │                                       │                            │
│  │     ├─► 如果model_params已训练              │                            │
│  │     │   - 使用训练参数预测K_predicted      │                            │
│  │     │   - 计算alpha_i = 1/(a × Re^(-p))    │                            │
│  │     │   - 更新k_management表               │                            │
│  │     │                                       │                            │
│  │     ├─► 如果model_params未训练              │                            │
│  │     │   - 使用默认参数预测                 │                            │
│  │     │   - a=1.0, p=0.85, b=0.0004          │                            │
│  │     │   - 同样更新k_management表           │                            │
│  │     │                                       │                            │
│  │     └─► 更新performance_parameters表       │                            │
│  │        - 添加alpha_i值                     │                            │
│  └─────────────────────────────────────────────┘                            │
│    ↓                                                                        │
│  ┌─────────────────────────────────────────────┐                            │
│  │  步骤8: 阶段2优化(条件触发)                 │                            │
│  │     • 触发条件:                            │                            │
│  │       - stage == 2                         │                            │
│  │       - hour == optimization_hours(默认3)  │                            │
│  │       - 不在重新处理历史数据模式           │                            │
│  │     • 执行操作:                            │                            │
│  │       - 获取优化数据                       │                            │
│  │         (当天前3小时 + 历史3天数据)        │                            │
│  │       - 执行阶段2训练                      │                            │
│  │       - 更新model_params                   │                            │
│  │       - 重新计算当天所有小时的K_predicted  │                            │
│  │       - 更新performance_parameters表的K值   │                            │
│  │       - 调用stage2_complete_callback       │                            │
│  └─────────────────────────────────────────────┘                            │
│    ↓                                                                        │
│  ┌─────────────────────────────────────────────┐                            │
│  │  步骤9: 误差检查和重新训练(条件触发)        │                            │
│  │     • 触发条件:                            │                            │
│  │       - hour == 23                         │                            │
│  │       - day > training_days                │                            │
│  │       - 平均误差 >= stage1_error_threshold │                            │
│  │     • 执行操作:                            │                            │
│  │       - 重新进入stage1                     │                            │
│  │       - model_params = None               │                            │
│  │       - 重新训练stage1                     │                            │
│  │       - 重新处理历史数据                   │                            │
│  │         (当前天 - stage1_history_days 到 当前天) │                     │
│  │       - 调用error_retrain_complete_callback│                            │
│  └─────────────────────────────────────────────┘                            │
│    ↓                                                                        │
│  返回处理结果                                                                │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3. 非线性回归计算流程 (`backend/calculation/nonlinear_regression.py`)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    非线性回归模型训练流程                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  输入: experimental_data(实验数据)                                          │
│    ↓                                                                        │
│  ┌─────────────────────────────────────────────┐                            │
│  │  1. 数据准备                                │                            │
│  │     • 提取雷诺数(Re)                        │                            │
│  │     • 计算Y = 1/K                          │                            │
│  │     • 数据清洗和标准化                      │                            │
│  └─────────────────────────────────────────────┘                            │
│    ↓                                                                        │
│  ┌─────────────────────────────────────────────┐                            │
│  │  2. 设置初始参数和边界                      │                            │
│  │     • 初始猜测: [a, p, b]                  │                            │
│  │     • 边界条件根据阶段和策略调整:           │                            │
│  │       - stage1保守策略:                    │                            │
│  │         a: [1e-6, 20], p: [0.4, 0.9],      │                            │
│  │         b: [0.0001, 0.0006]                │                            │
│  │       - stage2动态策略:                    │                            │
│  │         a: [1e-6, 30], p: [0.45, 0.9],     │                            │
│  │         b: [0.0002, 0.0006]                │                            │
│  └─────────────────────────────────────────────┘                            │
│    ↓                                                                        │
│  ┌─────────────────────────────────────────────┐                            │
│  │  3. 损失函数计算                            │                            │
│  │     • combined_loss = 0.7×r2_loss +         │                            │
│  │                     0.3×relative_error_normalized │                    │
│  │     • r2_loss = ss_res / ss_tot             │                            │
│  │     • relative_error_normalized =           │                            │
│  │       Σ((y_actual-y_pred)/y_actual)² / n    │                            │
│  └─────────────────────────────────────────────┘                            │
│    ↓                                                                        │
│  ┌─────────────────────────────────────────────┐                            │
│  │  4. 参数优化                                │                            │
│  │     • 使用L-BFGS-B方法                      │                            │
│  │     • 使用Nelder-Mead方法                   │                            │
│  │     • 选择损失更小的结果                    │                            │
│  └─────────────────────────────────────────────┘                            │
│    ↓                                                                        │
│  ┌─────────────────────────────────────────────┐                            │
│  │  5. 参数验证                                │                            │
│  │     • 确保参数在物理合理范围内              │                            │
│  │     • a_opt = max(1e-6, a_opt)             │                            │
│  │     • p_opt = max(0.4, min(p_opt, 1.2))    │                            │
│  │     • b_opt = max(1e-6, b_opt)             │                            │
│  └─────────────────────────────────────────────┘                            │
│    ↓                                                                        │
│  返回优化参数: a_opt, p_opt, b_opt                                           │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4. 两阶段训练策略流程图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       两阶段训练策略                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────┐                 ┌─────────────────┐                  │
│  │   阶段1: 初始训练  │                 │   阶段2: 精细优化  │                  │
│  │  (第1-20天)      │                 │  (第21天开始)     │                  │
│  └────────┬────────┘                 └────────┬────────┘                  │
│           │                                    │                           │
│           ▼                                    ▼                           │
│  ┌─────────────────┐                 ┌─────────────────┐                  │
│  │ 使用前20天数据   │                 │ 使用新数据+历史数据│                  │
│  │ 进行初始拟合     │                 │ 进行参数优化      │                  │
│  └────────┬────────┘                 └────────┬────────┘                  │
│           │                                    │                           │
│           ▼                                    ▼                           │
│  ┌─────────────────┐                 ┌─────────────────┐                  │
│  │ 得到基础参数     │                 │ 得到优化参数     │                  │
│  │ a, p, b         │                 │ a_opt, p_opt, b_opt │              │
│  └────────┬────────┘                 └────────┬────────┘                  │
│           │                                    │                           │
│           └────────────────┬───────────────────┘                           │
│                            │                                              │
│                            ▼                                              │
│                  ┌─────────────────┐                                     │
│                  │  误差检查机制    │                                     │
│                  └────────┬────────┘                                     │
│                           │                                              │
│                  ┌────────┴────────┐                                     │
│           ┌──────┴──────┐   ┌──────┴──────┐                             │
│           │误差<阈值     │   │误差≥阈值     │                             │
│           │(继续阶段2)    │   │(触发重新训练) │                             │
│           └──────────────┘   └──────┬──────┘                             │
│                                     │                                    │
│                                     ▼                                    │
│                           ┌─────────────────┐                           │
│                           │ 重新进入阶段1    │                           │
│                           │ 重新训练参数     │                           │
│                           └─────────────────┘                           │
│                                     │                                    │
│                                     ▼                                    │
│                           ┌─────────────────┐                           │
│                           │ 重新处理历史数据 │                           │
│                           │ (覆盖输出文件)   │                           │
│                           └─────────────────┘                           │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5. 数据库交互流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         数据库交互流程                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         测试数据库                                     │   │
│  │                    (heat_exchanger_monitor_db_test)                  │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │   │
│  │  │ operation_      │  │ physical_       │  │ performance_    │  │   │
│  │  │ parameters      │  │ parameters      │  │ parameters      │  │   │
│  │  │ (原始运行数据)   │  │ (原始物性数据)   │  │ (测试性能数据)   │  │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │ 读取数据                              │
│                                    ▼                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                       MainCalculator                                │   │
│  │                    (数据处理和计算引擎)                              │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐             │   │
│  │  │ 数据读取      │  │ 参数计算      │  │ 模型训练      │             │   │
│  │  │ 模块         │  │ 模块         │  │ 模块         │             │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘             │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │ 写入结果                              │
│                                    ▼                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         生产数据库                                     │   │
│  │                    (heat_exchanger_monitor_db)                      │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │   │
│  │  │ heat_exchanger  │  │ operation_      │  │ physical_       │  │   │
│  │  │ (换热器信息)     │  │ parameters      │  │ parameters      │  │   │
│  │  │                 │  │ (运行参数)       │  │ (物性参数)       │  │   │
│  │  ├─────────────────┤  ├─────────────────┤  ├─────────────────┤  │   │
│  │  │ performance_    │  │ k_management    │  │ model_          │  │   │
│  │  │ parameters      │  │ (K值管理)        │  │ parameters      │  │   │
│  │  │ (性能参数)       │  │                 │  │ (模型参数)       │  │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │ 查询数据                              │
│                                    ▼                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        FastAPI服务                                  │   │
│  │                    (提供数据查询接口)                               │   │
│  │  ┌─────────────────────────────────────────────────────────────┐  │   │
│  │  │ API接口:                                                     │  │   │
│  │  │ • /heat-exchangers        (换热器信息)                        │  │   │
│  │  │ • /operation-parameters   (运行参数)                          │  │   │
│  │  │ • /physical-parameters    (物性参数)                          │  │   │
│  │  │ • /performance-parameters (性能参数)                          │  │   │
│  │  │ • /k-management           (K值管理数据)                       │  │   │
│  │  │ • /model-parameters       (模型参数)                          │  │   │
│  │  └─────────────────────────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │ 返回JSON数据                          │
│                                    ▼                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                       自动数据处理脚本                               │   │
│  │                    (调用API并保存结果)                              │   │
│  │  ┌─────────────────────────────────────────────────────────────┐  │   │
│  │  │ 输出文件: output/day{day}_hour{hour}.txt                     │  │   │
│  │  └─────────────────────────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 关键配置参数

### 脚本配置 (`script/config.json`)
```json
{
  "api_url": "http://localhost:8000",
  "interval_minutes": 0.5,
  "start_day": 1,
  "start_hour": 0,
  "output_dir": "../output"
}
```

### 后端配置 (`backend/config/config.json`)
```json
{
  "training_days": 20,
  "history_days": 3,
  "optimization_hours": 3,
  "stage1_error_threshold": 5,
  "stage1_history_days": 5
}
```

## 系统特点总结

1. **自动化处理**：定时调度，自动处理每小时数据
2. **两阶段训练**：阶段1基础拟合，阶段2精细优化
3. **自适应策略**：根据误差动态调整优化策略
4. **误差检测**：自动检测误差并触发重新训练
5. **完整日志**：详细记录处理过程和错误信息
6. **数据持久化**：结果保存到数据库和文件系统
7. **API支持**：提供数据查询接口

## 文件位置说明

- **自动数据处理脚本**: `script/auto_data_processing.py`
- **主计算引擎**: `backend/calculation/main_calculator.py`
- **非线性回归计算器**: `backend/calculation/nonlinear_regression.py`
- **LMTD计算器**: `backend/calculation/lmtd_calculator.py`
- **数据加载器**: `backend/db/data_loader.py`
- **数据库连接**: `backend/db/db_connection.py`
- **API服务**: `backend/api/main.py`
- **配置文件**: `script/config.json`, `backend/config/config.json`
- **输出文件**: `output/day{day}_hour{hour}.txt`

---

*本文档生成时间: 2025年12月30日*  
*基于: script/auto_data_processing.py, backend/calculation/, files/需求文档.md*