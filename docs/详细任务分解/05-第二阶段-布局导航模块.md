# 第二阶段：布局导航模块 - 详细任务分解

**阶段目标**：实现应用的主布局结构，包括顶部导航栏、侧边菜单栏、响应式布局和完整的路由导航系统  
**预估工期**：3人日  
**关键产出**：完整可用的应用布局框架，支持响应式设计、路由导航、用户信息展示和权限控制

---

## 任务清单

### T2.4.1 实现主布局组件

#### 任务描述
1. **创建顶部导航栏组件**：
   - 实现应用Logo、系统标题显示
   - 添加用户信息展示和快捷操作
   - 实现主题切换、全屏切换等实用功能

2. **创建侧边导航树组件**：
   - 实现多级菜单导航
   - 支持菜单折叠/展开
   - 集成权限控制，只显示有权限的菜单

3. **实现响应式布局切换**：
   - 桌面端、平板端、移动端适配
   - 侧边菜单折叠功能
   - 移动端抽屉式菜单

4. **集成用户信息和退出功能**：
   - 显示当前用户信息和头像
   - 实现退出登录功能
   - 添加用户设置入口

#### 技术细节与实现步骤

**步骤1：创建布局组件结构**
```javascript
// src/layouts/DefaultLayout.vue - 主布局组件
<template>
  <div class="layout-container" :class="layoutClasses">
    <!-- 侧边菜单栏 -->
    <aside class="sidebar" :class="{ collapsed: isSidebarCollapsed }">
      <div class="sidebar-header">
        <div class="logo">
          <router-link to="/dashboard">
            <svg class="logo-icon" viewBox="0 0 24 24">
              <path d="M12,2L4,6V18L12,22L20,18V6L12,2Z" fill="currentColor" />
              <path d="M12,10L8,12V16L12,18L16,16V12L12,10Z" fill="currentColor" opacity="0.7" />
            </svg>
            <span class="logo-text" v-show="!isSidebarCollapsed">
              换热器监测
            </span>
          </router-link>
        </div>
        <el-button
          class="collapse-button"
          type="text"
          @click="toggleSidebar"
          :icon="isSidebarCollapsed ? Expand : Fold"
        />
      </div>
      
      <!-- 菜单组件 -->
      <side-menu
        :collapsed="isSidebarCollapsed"
        :menus="filteredMenus"
        @menu-click="handleMenuClick"
      />
      
      <!-- 侧边栏底部 -->
      <div class="sidebar-footer" v-show="!isSidebarCollapsed">
        <div class="system-status">
          <el-tag type="success" size="small">在线</el-tag>
          <span class="status-text">系统运行正常</span>
        </div>
      </div>
    </aside>
    
    <!-- 主内容区域 -->
    <div class="main-container">
      <!-- 顶部导航栏 -->
      <header class="header">
        <div class="header-left">
          <el-breadcrumb separator="/">
            <el-breadcrumb-item v-for="item in breadcrumbs" :key="item.path">
              <router-link v-if="item.path" :to="item.path">
                {{ item.title }}
              </router-link>
              <span v-else>{{ item.title }}</span>
            </el-breadcrumb-item>
          </el-breadcrumb>
        </div>
        
        <div class="header-right">
          <!-- 搜索框 -->
          <div class="search-box">
            <el-input
              v-model="searchKeyword"
              placeholder="搜索换热器、报警..."
              size="small"
              :prefix-icon="Search"
              @keyup.enter="handleSearch"
            />
          </div>
          
          <!-- 功能按钮 -->
          <div class="header-actions">
            <!-- 全屏切换 -->
            <el-tooltip content="全屏" placement="bottom">
              <el-button
                type="text"
                :icon="isFullscreen ? FullScreenExit : FullScreen"
                @click="toggleFullscreen"
              />
            </el-tooltip>
            
            <!-- 主题切换 -->
            <el-tooltip content="切换主题" placement="bottom">
              <el-button
                type="text"
                :icon="themeIcon"
                @click="toggleTheme"
              />
            </el-tooltip>
            
            <!-- 通知中心 -->
            <notification-badge
              :count="unreadNotifications"
              @click="showNotifications"
            />
            
            <!-- 用户菜单 -->
            <user-dropdown
              :user="currentUser"
              @logout="handleLogout"
            />
          </div>
        </div>
      </header>
      
      <!-- 标签页导航（可选） -->
      <div class="tags-view" v-if="showTagsView">
        <tags-view />
      </div>
      
      <!-- 页面内容区域 -->
      <main class="content-wrapper">
        <!-- 页面过渡效果 -->
        <router-view v-slot="{ Component }">
          <transition name="fade-transform" mode="out-in">
            <component :is="Component" />
          </transition>
        </router-view>
      </main>
      
      <!-- 底部信息栏 -->
      <footer class="footer" v-if="showFooter">
        <div class="footer-content">
          <span>© 2026 换热器监测系统 v{{ appVersion }}</span>
          <span class="divider">|</span>
          <span>技术支持：工业监控部门</span>
          <span class="divider">|</span>
          <span>服务器状态：<el-tag size="small" type="success">正常</el-tag></span>
        </div>
      </footer>
    </div>
    
    <!-- 移动端菜单遮罩 -->
    <div
      class="sidebar-mask"
      v-if="isMobile && !isSidebarCollapsed"
      @click="toggleSidebar"
    />
  </div>
</template>

<script setup>
import { ref, computed, onMounted, onUnmounted } from 'vue'
import { useRoute, useRouter } from 'vue-router'
import { useAuthStore } from '@/stores/auth'
import { useAppStore } from '@/stores/app'
import { 
  Expand, 
  Fold, 
  Search,
  FullScreen,
  FullScreenExit,
  Sunny,
  Moon
} from '@element-plus/icons-vue'
import SideMenu from '@/components/layout/SideMenu.vue'
import UserDropdown from '@/components/layout/UserDropdown.vue'
import NotificationBadge from '@/components/layout/NotificationBadge.vue'
import TagsView from '@/components/layout/TagsView.vue'
import { useFullscreen } from '@vueuse/core'
import { debounce } from '@/utils/debounce-throttle'

// 路由和Store
const route = useRoute()
const router = useRouter()
const authStore = useAuthStore()
const appStore = useAppStore()

// 响应式数据
const searchKeyword = ref('')
const isMobile = ref(false)
const isSidebarCollapsed = ref(false)
const showTagsView = ref(false)
const showFooter = ref(true)
const unreadNotifications = ref(0)

// 全屏控制
const { isFullscreen, toggle: toggleFullscreen } = useFullscreen()

// 计算属性
const currentUser = computed(() => authStore.currentUser)
const appVersion = computed(() => import.meta.env.VITE_APP_VERSION || '1.0.0')
const themeIcon = computed(() => appStore.theme === 'dark' ? Moon : Sunny)

// 过滤后的菜单（根据权限）
const filteredMenus = computed(() => {
  const allMenus = appStore.menus
  if (!authStore.isAuthenticated) return []
  
  return allMenus.filter(menu => {
    // 检查菜单权限
    if (menu.permissions && !authStore.hasAnyPermission(menu.permissions)) {
      return false
    }
    
    // 检查角色
    if (menu.roles && !menu.roles.includes(authStore.userRole)) {
      return false
    }
    
    return true
  })
})

// 面包屑导航
const breadcrumbs = computed(() => {
  const crumbs = []
  let current = route
  
  while (current) {
    if (current.meta?.breadcrumb) {
      crumbs.unshift({
        title: current.meta.title || '',
        path: current.path
      })
    }
    current = current.matched[current.matched.length - 2]
  }
  
  // 添加首页
  if (crumbs.length === 0 || crumbs[0].path !== '/dashboard') {
    crumbs.unshift({
      title: '首页',
      path: '/dashboard'
    })
  }
  
  return crumbs
})

// 布局类
const layoutClasses = computed(() => ({
  'mobile': isMobile.value,
  'collapsed': isSidebarCollapsed.value,
  [`theme-${appStore.theme}`]: true
}))

// 方法
// 切换侧边栏
function toggleSidebar() {
  isSidebarCollapsed.value = !isSidebarCollapsed.value
  appStore.setSidebarCollapsed(isSidebarCollapsed.value)
}

// 切换主题
function toggleTheme() {
  appStore.toggleTheme()
}

// 处理搜索
const handleSearch = debounce(() => {
  if (!searchKeyword.value.trim()) return
  
  router.push({
    path: '/search',
    query: { q: searchKeyword.value }
  })
  searchKeyword.value = ''
}, 300)

// 处理菜单点击
function handleMenuClick(menu) {
  if (menu.path) {
    router.push(menu.path)
  }
}

// 处理退出
async function handleLogout() {
  try {
    await authStore.logout()
    router.push('/login')
  } catch (error) {
    console.error('退出失败:', error)
  }
}

// 显示通知
function showNotifications() {
  appStore.showNotificationPanel()
}

// 检查设备类型
function checkIsMobile() {
  isMobile.value = window.innerWidth < 768
  
  // 移动端默认折叠侧边栏
  if (isMobile.value) {
    isSidebarCollapsed.value = true
  }
}

// 监听窗口大小变化
const handleResize = debounce(() => {
  checkIsMobile()
}, 150)

// 生命周期
onMounted(() => {
  checkIsMobile()
  window.addEventListener('resize', handleResize)
  
  // 恢复侧边栏状态
  isSidebarCollapsed.value = appStore.sidebarCollapsed
})

onUnmounted(() => {
  window.removeEventListener('resize', handleResize)
})
</script>

<style scoped lang="scss">
@import '@/assets/styles/variables.scss';

.layout-container {
  display: flex;
  height: 100vh;
  overflow: hidden;
  background: color(background);
  transition: all 0.3s ease;
  
  &.collapsed {
    .sidebar {
      width: var(--sidebar-collapsed-width);
      
      .logo-text {
        opacity: 0;
        width: 0;
      }
      
      .sidebar-footer {
        opacity: 0;
      }
    }
  }
  
  &.mobile {
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      z-index: 1001;
      transform: translateX(0);
      transition: transform 0.3s ease;
      
      &.collapsed {
        transform: translateX(-100%);
      }
    }
    
    .main-container {
      margin-left: 0;
    }
  }
}

// 侧边栏样式
.sidebar {
  width: var(--sidebar-width);
  background: linear-gradient(180deg, color(primary) 0%, darken(color(primary), 10%) 100%);
  color: white;
  display: flex;
  flex-direction: column;
  transition: width 0.3s ease;
  position: relative;
  z-index: 1000;
  box-shadow: 2px 0 8px rgba(0, 0, 0, 0.15);
  
  .sidebar-header {
    height: var(--header-height);
    padding: 0 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    
    .logo {
      a {
        display: flex;
        align-items: center;
        text-decoration: none;
        color: white;
        
        .logo-icon {
          width: 32px;
          height: 32px;
          flex-shrink: 0;
        }
        
        .logo-text {
          margin-left: 12px;
          font-size: 18px;
          font-weight: 600;
          white-space: nowrap;
          transition: opacity 0.3s ease, width 0.3s ease;
          overflow: hidden;
        }
        
        &:hover {
          opacity: 0.9;
        }
      }
    }
    
    .collapse-button {
      color: white;
      font-size: 18px;
      
      &:hover {
        background: rgba(255, 255, 255, 0.1);
      }
    }
  }
  
  .sidebar-footer {
    padding: 16px 20px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    background: rgba(0, 0, 0, 0.1);
    transition: opacity 0.3s ease;
    
    .system-status {
      display: flex;
      align-items: center;
      gap: 8px;
      
      .status-text {
        font-size: 12px;
        opacity: 0.8;
      }
    }
  }
}

// 移动端遮罩
.sidebar-mask {
  position: fixed;
  top: 0;
  right: 0;
  bottom: 0;
  left: 0;
  z-index: 1000;
  background: rgba(0, 0, 0, 0.5);
}

// 主内容区域
.main-container {
  flex: 1;
  display: flex;
  flex-direction: column;
  min-width: 0;
  margin-left: 0;
  transition: margin-left 0.3s ease;
  
  .layout-container:not(.mobile):not(.collapsed) & {
    margin-left: var(--sidebar-width);
  }
  
  .layout-container.collapsed:not(.mobile) & {
    margin-left: var(--sidebar-collapsed-width);
  }
}

// 头部样式
.header {
  height: var(--header-height);
  background: white;
  border-bottom: 1px solid color(border);
  padding: 0 24px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
  z-index: 100;
  
  .header-left {
    flex: 1;
    
    :deep(.el-breadcrumb) {
      font-size: 14px;
      
      .el-breadcrumb__inner {
        color: color(gray-600);
        
        a {
          color: color(primary);
          text-decoration: none;
          
          &:hover {
            color: color(primary-dark);
            text-decoration: underline;
          }
        }
      }
      
      .el-breadcrumb__item:last-child {
        .el-breadcrumb__inner {
          color: color(gray-900);
          font-weight: 500;
        }
      }
    }
  }
  
  .header-right {
    display: flex;
    align-items: center;
    gap: 20px;
    
    .search-box {
      width: 240px;
      
      :deep(.el-input) {
        .el-input__wrapper {
          border-radius: 20px;
          background: color(gray-100);
          border: 1px solid color(gray-200);
          
          &:hover {
            border-color: color(primary);
            background: white;
          }
          
          &.is-focus {
            border-color: color(primary);
            box-shadow: 0 0 0 1px color(primary);
            background: white;
          }
        }
      }
    }
    
    .header-actions {
      display: flex;
      align-items: center;
      gap: 12px;
      
      .el-button {
        color: color(gray-600);
        font-size: 18px;
        
        &:hover {
          color: color(primary);
          background: color(gray-100);
        }
      }
    }
  }
}

// 标签页导航
.tags-view {
  height: 40px;
  background: white;
  border-bottom: 1px solid color(border);
  padding: 0 24px;
  display: flex;
  align-items: center;
  overflow-x: auto;
}

// 内容区域
.content-wrapper {
  flex: 1;
  padding: 24px;
  overflow-y: auto;
  background: color(background);
  
  // 页面过渡动画
  .fade-transform-enter-active,
  .fade-transform-leave-active {
    transition: all 0.3s ease;
  }
  
  .fade-transform-enter-from {
    opacity: 0;
    transform: translateX(-30px);
  }
  
  .fade-transform-leave-to {
    opacity: 0;
    transform: translateX(30px);
  }
}

// 底部样式
.footer {
  height: 40px;
  background: white;
  border-top: 1px solid color(border);
  padding: 0 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  
  .footer-content {
    font-size: 12px;
    color: color(gray-500);
    display: flex;
    align-items: center;
    gap: 12px;
    
    .divider {
      color: color(gray-300);
    }
  }
}

// 响应式调整
@media (max-width: 992px) {
  .header {
    padding: 0 16px;
    
    .header-right {
      .search-box {
        width: 180px;
      }
    }
  }
  
  .content-wrapper {
    padding: 16px;
  }
}

@media (max-width: 768px) {
  .header {
    .header-right {
      .search-box {
        display: none;
      }
    }
  }
  
  .footer {
    .footer-content {
      flex-direction: column;
      gap: 4px;
      text-align: center;
      
      .divider {
        display: none;
      }
    }
  }
}
</style>
```

**步骤2：创建侧边菜单组件**
```vue
<!-- src/components/layout/SideMenu.vue -->
<template>
  <div class="side-menu">
    <el-scrollbar>
      <el-menu
        :default-active="activeMenu"
        :collapse="collapsed"
        :background-color="menuBackground"
        :text-color="menuTextColor"
        :active-text-color="menuActiveColor"
        :unique-opened="true"
        @select="handleSelect"
      >
        <!-- 动态生成菜单 -->
        <template v-for="menu in menus" :key="menu.path">
          <!-- 有子菜单的情况 -->
          <el-sub-menu
            v-if="menu.children && menu.children.length > 0"
            :index="menu.path"
          >
            <template #title>
              <el-icon v-if="menu.icon">
                <component :is="menu.icon" />
              </el-icon>
              <span>{{ menu.title }}</span>
              
              <!-- 角标提示 -->
              <el-badge
                v-if="menu.badge"
                :value="menu.badge"
                :type="menu.badgeType || 'danger'"
                class="menu-badge"
              />
            </template>
            
            <!-- 子菜单项 -->
            <el-menu-item
              v-for="child in menu.children"
              :key="child.path"
              :index="child.path"
            >
              <template #title>
                <span>{{ child.title }}</span>
                
                <!-- 子菜单角标 -->
                <el-badge
                  v-if="child.badge"
                  :value="child.badge"
                  :type="child.badgeType || 'danger'"
                  class="menu-badge"
                />
              </template>
              
              <!-- 子菜单图标 -->
              <el-icon v-if="child.icon">
                <component :is="child.icon" />
              </el-icon>
            </el-menu-item>
          </el-sub-menu>
          
          <!-- 没有子菜单的情况 -->
          <el-menu-item
            v-else
            :index="menu.path"
          >
            <el-icon v-if="menu.icon">
              <component :is="menu.icon" />
            </el-icon>
            <template #title>
              <span>{{ menu.title }}</span>
              
              <!-- 角标提示 -->
              <el-badge
                v-if="menu.badge"
                :value="menu.badge"
                :type="menu.badgeType || 'danger'"
                class="menu-badge"
              />
            </template>
          </el-menu-item>
        </template>
      </el-menu>
    </el-scrollbar>
  </div>
</template>

<script setup>
import { computed } from 'vue'
import { useRoute } from 'vue-router'
import { useAppStore } from '@/stores/app'

const props = defineProps({
  menus: {
    type: Array,
    default: () => []
  },
  collapsed: {
    type: Boolean,
    default: false
  }
})

const emit = defineEmits(['menu-click'])

const route = useRoute()
const appStore = useAppStore()

// 计算属性
const activeMenu = computed(() => {
  const { path } = route
  return path
})

const menuBackground = computed(() => {
  return appStore.theme === 'dark' ? '#1a237e' : 'transparent'
})

const menuTextColor = computed(() => {
  return appStore.theme === 'dark' ? 'rgba(255, 255, 255, 0.7)' : 'rgba(255, 255, 255, 0.9)'
})

const menuActiveColor = computed(() => {
  return appStore.theme === 'dark' ? '#64b5f6' : '#ffffff'
})

// 方法
function handleSelect(index, indexPath) {
  const menu = findMenuByPath(props.menus, index)
  if (menu) {
    emit('menu-click', menu)
  }
}

function findMenuByPath(menus, path) {
  for (const menu of menus) {
    if (menu.path === path) {
      return menu
    }
    
    if (menu.children) {
      const found = findMenuByPath(menu.children, path)
      if (found) return found
    }
  }
  
  return null
}
</script>

<style scoped lang="scss">
@import '@/assets/styles/variables.scss';

.side-menu {
  flex: 1;
  height: 0; // 让scrollbar正常工作
  
  :deep(.el-scrollbar) {
    height: 100%;
    
    .el-scrollbar__view {
      height: 100%;
    }
  }
  
  :deep(.el-menu) {
    border: none;
    background: transparent;
    
    .el-menu-item,
    .el-sub-menu__title {
      height: 48px;
      line-height: 48px;
      margin: 4px 8px;
      border-radius: 8px;
      
      &:hover {
        background: rgba(255, 255, 255, 0.1);
      }
      
      &.is-active {
        background: rgba(255, 255, 255, 0.15);
        font-weight: 500;
        
        &::after {
          content: '';
          position: absolute;
          right: 0;
          top: 50%;
          transform: translateY(-50%);
          width: 3px;
          height: 20px;
          background: v-bind(menuActiveColor);
          border-radius: 3px 0 0 3px;
        }
      }
      
      .el-icon {
        font-size: 18px;
        color: inherit;
      }
      
      span {
        transition: opacity 0.3s ease;
      }
      
      .menu-badge {
        position: absolute;
        right: 40px;
        top: 50%;
        transform: translateY(-50%);
      }
    }
    
    // 子菜单样式
    .el-menu--inline {
      background: rgba(0, 0, 0, 0.1);
      
      .el-menu-item {
        margin: 2px 8px;
        padding-left: 56px !important;
        
        &.is-active {
          background: rgba(255, 255, 255, 0.1);
        }
      }
    }
    
    // 折叠状态下的样式
    &.el-menu--collapse {
      .el-menu-item,
      .el-sub-menu {
        .el-sub-menu__title {
          padding: 0 20px !important;
          
          .menu-badge {
            display: none;
          }
        }
      }
      
      .el-tooltip__trigger {
        display: flex;
        justify-content: center;
      }
    }
  }
}
</style>
```

**步骤3：创建用户下拉菜单组件**
```vue
<!-- src/components/layout/UserDropdown.vue -->
<template>
  <div class="user-dropdown">
    <el-dropdown
      trigger="click"
      placement="bottom-end"
      @command="handleCommand"
    >
      <div class="user-info">
        <el-avatar
          :size="32"
          :src="user.avatar"
          :alt="user.displayName"
          class="user-avatar"
        >
          {{ user.displayName.charAt(0) }}
        </el-avatar>
        
        <div class="user-details" v-if="showDetails">
          <div class="user-name">{{ user.displayName }}</div>
          <div class="user-role">
            <el-tag :type="roleTagType" size="small">
              {{ user.getRoleDisplayName() }}
            </el-tag>
          </div>
        </div>
        
        <el-icon class="arrow-icon">
          <ArrowDown />
        </el-icon>
      </div>
      
      <template #dropdown>
        <el-dropdown-menu class="user-menu">
          <!-- 用户信息头部 -->
          <div class="menu-header">
            <div class="header-avatar">
              <el-avatar
                :size="48"
                :src="user.avatar"
                :alt="user.displayName"
              >
                {{ user.displayName.charAt(0) }}
              </el-avatar>
            </div>
            <div class="header-info">
              <div class="header-name">{{ user.displayName }}</div>
              <div class="header-email">{{ user.email }}</div>
              <div class="header-role">
                <el-tag :type="roleTagType" size="small">
                  {{ user.getRoleDisplayName() }}
                </el-tag>
                <el-tag
                  v-if="user.isOnline()"
                  type="success"
                  size="small"
                >
                  在线
                </el-tag>
              </div>
            </div>
          </div>
          
          <el-dropdown-divider />
          
          <!-- 菜单项 -->
          <el-dropdown-item command="profile">
            <el-icon><User /></el-icon>
            个人中心
          </el-dropdown-item>
          
          <el-dropdown-item command="settings">
            <el-icon><Setting /></el-icon>
            账户设置
          </el-dropdown-item>
          
          <el-dropdown-item command="notifications">
            <el-icon><Bell /></el-icon>
            消息通知
            <el-badge
              v-if="unreadCount > 0"
              :value="unreadCount"
              class="notification-badge"
            />
          </el-dropdown-item>
          
          <el-dropdown-divider />
          
          <!-- 换热器管理（工程师和管理员可见） -->
          <template v-if="showHeatExchangerMenu">
            <el-dropdown-item command="heat-exchangers">
              <el-icon><HeatExchanger /></el-icon>
              我的换热器
            </el-dropdown-item>
            
            <el-dropdown-item command="alerts">
              <el-icon><Warning /></el-icon>
              报警管理
              <el-badge
                v-if="unreadAlerts > 0"
                :value="unreadAlerts"
                type="danger"
                class="alert-badge"
              />
            </el-dropdown-item>
            
            <el-dropdown-divider />
          </template>
          
          <!-- 系统管理（管理员可见） -->
          <template v-if="showSystemMenu">
            <el-dropdown-item command="system">
              <el-icon><Monitor /></el-icon>
              系统管理
            </el-dropdown-item>
            
            <el-dropdown-item command="users">
              <el-icon><UserFilled /></el-icon>
              用户管理
            </el-dropdown-item>
            
            <el-dropdown-divider />
          </template>
          
          <!-- 帮助和反馈 -->
          <el-dropdown-item command="help">
            <el-icon><QuestionFilled /></el-icon>
            帮助中心
          </el-dropdown-item>
          
          <el-dropdown-item command="feedback">
            <el-icon><ChatLineRound /></el-icon>
            意见反馈
          </el-dropdown-item>
          
          <el-dropdown-divider />
          
          <!-- 退出登录 -->
          <el-dropdown-item command="logout" divided>
            <el-icon><SwitchButton /></el-icon>
            <span class="logout-text">退出登录</span>
          </el-dropdown-item>
        </el-dropdown-menu>
      </template>
    </el-dropdown>
  </div>
</template>

<script setup>
import { computed } from 'vue'
import { useRouter } from 'vue-router'
import { useAuthStore } from '@/stores/auth'
import {
  ArrowDown,
  User,
  Setting,
  Bell,
  Warning,
  Monitor,
  UserFilled,
  QuestionFilled,
  ChatLineRound,
  SwitchButton
} from '@element-plus/icons-vue'

const props = defineProps({
  user: {
    type: Object,
    required: true
  },
  showDetails: {
    type: Boolean,
    default: true
  }
})

const emit = defineEmits(['logout'])

const router = useRouter()
const authStore = useAuthStore()

// 模拟数据
const unreadCount = ref(3)
const unreadAlerts = ref(5)

// 计算属性
const roleTagType = computed(() => {
  const types = {
    'operator': 'primary',
    'engineer': 'success',
    'admin': 'warning'
  }
  return types[props.user.role] || 'info'
})

const showHeatExchangerMenu = computed(() => {
  return ['engineer', 'admin'].includes(props.user.role)
})

const showSystemMenu = computed(() => {
  return props.user.role === 'admin'
})

// 方法
function handleCommand(command) {
  switch (command) {
    case 'profile':
      router.push('/profile')
      break
      
    case 'settings':
      router.push('/profile/settings')
      break
      
    case 'notifications':
      router.push('/notifications')
      break
      
    case 'heat-exchangers':
      router.push('/heat-exchangers')
      break
      
    case 'alerts':
      router.push('/alerts')
      break
      
    case 'system':
      router.push('/system')
      break
      
    case 'users':
      router.push('/system/users')
      break
      
    case 'help':
      window.open('/help', '_blank')
      break
      
    case 'feedback':
      router.push('/feedback')
      break
      
    case 'logout':
      emit('logout')
      break
  }
}
</script>

<style scoped lang="scss">
@import '@/assets/styles/variables.scss';

.user-dropdown {
  .user-info {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 8px 12px;
    border-radius: 20px;
    cursor: pointer;
    transition: background-color 0.3s ease;
    
    &:hover {
      background: color(gray-100);
    }
    
    .user-avatar {
      flex-shrink: 0;
    }
    
    .user-details {
      text-align: left;
      line-height: 1.4;
      
      .user-name {
        font-weight: 500;
        font-size: 14px;
        color: color(gray-900);
        margin-bottom: 2px;
      }
      
      .user-role {
        :deep(.el-tag) {
          height: 20px;
          line-height: 18px;
          font-size: 11px;
          padding: 0 6px;
        }
      }
    }
    
    .arrow-icon {
      color: color(gray-500);
      font-size: 12px;
      margin-left: 4px;
    }
  }
}

.user-menu {
  min-width: 280px;
  padding: 0;
  
  .menu-header {
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 16px;
    
    .header-avatar {
      flex-shrink: 0;
    }
    
    .header-info {
      flex: 1;
      min-width: 0;
      
      .header-name {
        font-weight: 600;
        font-size: 16px;
        color: color(gray-900);
        margin-bottom: 4px;
        @include text-truncate;
      }
      
      .header-email {
        font-size: 12px;
        color: color(gray-600);
        margin-bottom: 8px;
        @include text-truncate;
      }
      
      .header-role {
        display: flex;
        gap: 6px;
        
        :deep(.el-tag) {
          height: 22px;
          line-height: 20px;
          font-size: 12px;
          padding: 0 8px;
        }
      }
    }
  }
  
  :deep(.el-dropdown-menu__item) {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 20px;
    font-size: 14px;
    
    .el-icon {
      font-size: 16px;
      color: color(gray-600);
      width: 20px;
    }
    
    &:hover {
      .el-icon {
        color: color(primary);
      }
    }
    
    .notification-badge,
    .alert-badge {
      margin-left: auto;
    }
    
    &.logout-item {
      .logout-text {
        color: color(error);
        font-weight: 500;
      }
      
      .el-icon {
        color: color(error);
      }
      
      &:hover {
        background: rgba(color(error), 0.1);
      }
    }
  }
}
</style>
```

**步骤4：创建应用状态Store**
```javascript
// src/stores/app.js
import { defineStore } from 'pinia'
import { ref, computed } from 'vue'
import { routes } from '@/router/routes'
import { PERMISSIONS } from '@/models/user'

/**
 * 应用状态管理Store
 */
export const useAppStore = defineStore('app', {
  state: () => ({
    // 侧边栏状态
    sidebarCollapsed: false,
    
    // 主题设置
    theme: 'light', // light, dark, blue
    themes: ['light', 'dark', 'blue'],
    
    // 布局设置
    showTagsView: true,
    showFooter: true,
    showBreadcrumb: true,
    
    // 菜单数据
    menus: [
      {
        path: '/dashboard',
        title: '仪表盘',
        icon: 'Dashboard',
        roles: ['operator', 'engineer', 'admin'],
        permissions: [PERMISSIONS.VIEW_DASHBOARD],
        badge: null
      },
      {
        path: '/heat-exchangers',
        title: '换热器管理',
        icon: 'HeatExchanger',
        roles: ['operator', 'engineer', 'admin'],
        permissions: [PERMISSIONS.VIEW_HEAT_EXCHANGERS],
        badge: 3,
        badgeType: 'warning',
        children: [
          {
            path: '/heat-exchangers/list',
            title: '换热器列表',
            icon: 'List'
          },
          {
            path: '/heat-exchangers/map',
            title: '地理位置',
            icon: 'MapLocation'
          },
          {
            path: '/heat-exchangers/analysis',
            title: '性能分析',
            icon: 'TrendCharts',
            roles: ['engineer', 'admin'],
            permissions: [PERMISSIONS.VIEW_REPORTS]
          }
        ]
      },
      {
        path: '/alerts',
        title: '报警管理',
        icon: 'Bell',
        roles: ['operator', 'engineer', 'admin'],
        permissions: [PERMISSIONS.VIEW_ALERTS],
        badge: 5,
        badgeType: 'danger',
        children: [
          {
            path: '/alerts/active',
            title: '活跃报警',
            icon: 'Warning'
          },
          {
            path: '/alerts/history',
            title: '历史报警',
            icon: 'Clock'
          },
          {
            path: '/alerts/rules',
            title: '报警规则',
            icon: 'Setting',
            roles: ['engineer', 'admin'],
            permissions: [PERMISSIONS.MANAGE_HEAT_EXCHANGERS]
          }
        ]
      },
      {
        path: '/reports',
        title: '报表分析',
        icon: 'Document',
        roles: ['engineer', 'admin'],
        permissions: [PERMISSIONS.VIEW_REPORTS],
        children: [
          {
            path: '/reports/daily',
            title: '日报表',
            icon: 'Calendar'
          },
          {
            path: '/reports/weekly',
            title: '周报表',
            icon: 'DataLine'
          },
          {
            path: '/reports/monthly',
            title: '月报表',
            icon: 'PieChart'
          },
          {
            path: '/reports/custom',
            title: '自定义报表',
            icon: 'SetUp'
          }
        ]
      },
      {
        path: '/system',
        title: '系统管理',
        icon: 'Setting',
        roles: ['admin'],
        permissions: [PERMISSIONS.MANAGE_SYSTEM_SETTINGS],
        children: [
          {
            path: '/system/users',
            title: '用户管理',
            icon: 'User'
          },
          {
            path: '/system/roles',
            title: '角色管理',
            icon: 'UserFilled'
          },
          {
            path: '/system/logs',
            title: '系统日志',
            icon: 'Document'
          },
          {
            path: '/system/settings',
            title: '系统设置',
            icon: 'Tools'
          }
        ]
      }
    ],
    
    // 通知面板状态
    notificationPanelVisible: false,
    
    // 全局加载状态
    globalLoading: false,
    loadingText: '加载中...',
    
    // 错误状态
    globalError: null,
    
    // 搜索历史
    searchHistory: []
  }),
  
  getters: {
    /**
     * 获取当前主题配置
     */
    currentTheme: (state) => {
      const themes = {
        light: {
          name: 'light',
          primary: '#1a237e',
          background: '#f5f5f5',
          text: '#212121'
        },
        dark: {
          name: 'dark',
          primary: '#534bae',
          background: '#121212',
          text: '#ffffff'
        },
        blue: {
          name: 'blue',
          primary: '#1565c0',
          background: '#f5f7fa',
          text: '#263238'
        }
      }
      
      return themes[state.theme] || themes.light
    },
    
    /**
     * 获取下一个主题
     */
    nextTheme: (state) => {
      const currentIndex = state.themes.indexOf(state.theme)
      const nextIndex = (currentIndex + 1) % state.themes.length
      return state.themes[nextIndex]
    },
    
    /**
     * 获取当前主题图标
     */
    themeIcon: (state) => {
      const icons = {
        light: 'Sunny',
        dark: 'Moon',
        blue: 'Cloudy'
      }
      return icons[state.theme] || 'Sunny'
    },
    
    /**
     * 获取可访问的路由
     */
    accessibleRoutes: (state) => (userPermissions) => {
      return routes.filter(route => {
        if (!route.meta || !route.meta.permissions) {
          return true
        }
        
        const requiredPermissions = route.meta.permissions
        if (Array.isArray(requiredPermissions)) {
          return requiredPermissions.some(permission => 
            userPermissions.includes(permission)
          )
        }
        
        return userPermissions.includes(requiredPermissions)
      })
    }
  },
  
  actions: {
    /**
     * 切换侧边栏状态
     */
    toggleSidebar() {
      this.sidebarCollapsed = !this.sidebarCollapsed
      this.saveToStorage()
    },
    
    /**
     * 设置侧边栏状态
     */
    setSidebarCollapsed(collapsed) {
      this.sidebarCollapsed = collapsed
      this.saveToStorage()
    },
    
    /**
     * 切换主题
     */
    toggleTheme() {
      const currentIndex = this.themes.indexOf(this.theme)
      const nextIndex = (currentIndex + 1) % this.themes.length
      this.theme = this.themes[nextIndex]
      this.applyTheme()
      this.saveToStorage()
    },
    
    /**
     * 设置主题
     */
    setTheme(themeName) {
      if (this.themes.includes(themeName)) {
        this.theme = themeName
        this.applyTheme()
        this.saveToStorage()
      }
    },
    
    /**
     * 应用主题到DOM
     */
    applyTheme() {
      const theme = this.currentTheme
      
      // 更新CSS变量
      document.documentElement.style.setProperty('--color-primary', theme.primary)
      document.documentElement.style.setProperty('--color-background', theme.background)
      document.documentElement.style.setProperty('--color-text', theme.text)
      
      // 更新body类名
      document.body.className = `theme-${theme.name}`
      
      // 触发主题变更事件
      window.dispatchEvent(new CustomEvent('theme-change', { detail: theme }))
    },
    
    /**
     * 显示通知面板
     */
    showNotificationPanel() {
      this.notificationPanelVisible = true
    },
    
    /**
     * 隐藏通知面板
     */
    hideNotificationPanel() {
      this.notificationPanelVisible = false
    },
    
    /**
     * 开始全局加载
     */
    startLoading(text = '加载中...') {
      this.globalLoading = true
      this.loadingText = text
    },
    
    /**
     * 结束全局加载
     */
    stopLoading() {
      this.globalLoading = false
      this.loadingText = '加载中...'
    },
    
    /**
     * 设置全局错误
     */
    setGlobalError(error) {
      this.globalError = error
    },
    
    /**
     * 清除全局错误
     */
    clearGlobalError() {
      this.globalError = null
    },
    
    /**
     * 添加搜索历史
     */
    addSearchHistory(query) {
      if (!query.trim()) return
      
      // 移除重复项
      this.searchHistory = this.searchHistory.filter(
        item => item.toLowerCase() !== query.toLowerCase()
      )
      
      // 添加到开头
      this.searchHistory.unshift(query)
      
      // 限制历史记录数量
      if (this.searchHistory.length > 10) {
        this.searchHistory.pop()
      }
      
      this.saveToStorage()
    },
    
    /**
     * 清空搜索历史
     */
    clearSearchHistory() {
      this.searchHistory = []
      this.saveToStorage()
    },
    
    /**
     * 保存状态到localStorage
     */
    saveToStorage() {
      try {
        const stateToSave = {
          sidebarCollapsed: this.sidebarCollapsed,
          theme: this.theme,
          showTagsView: this.showTagsView,
          showFooter: this.showFooter,
          showBreadcrumb: this.showBreadcrumb,
          searchHistory: this.searchHistory
        }
        
        localStorage.setItem('app_settings', JSON.stringify(stateToSave))
      } catch (error) {
        console.error('保存应用设置失败:', error)
      }
    },
    
    /**
     * 从localStorage恢复状态
     */
    restoreFromStorage() {
      try {
        const saved = localStorage.getItem('app_settings')
        if (saved) {
          const state = JSON.parse(saved)
          
          this.sidebarCollapsed = state.sidebarCollapsed ?? this.sidebarCollapsed
          this.theme = state.theme ?? this.theme
          this.showTagsView = state.showTagsView ?? this.showTagsView
          this.showFooter = state.showFooter ?? this.showFooter
          this.showBreadcrumb = state.showBreadcrumb ?? this.showBreadcrumb
          this.searchHistory = state.searchHistory ?? this.searchHistory
          
          // 应用恢复的主题
          this.applyTheme()
        }
      } catch (error) {
        console.error('恢复应用设置失败:', error)
      }
    }
  },
  
  /**
   * 状态持久化配置
   */
  persist: {
    key: 'heat_exchanger_app',
    storage: localStorage,
    paths: [
      'sidebarCollapsed',
      'theme',
      'showTagsView',
      'showFooter',
      'showBreadcrumb',
      'searchHistory'
    ]
  }
})
```

#### 验收条件
1. **布局组件验证**：
   - 主布局组件能正确渲染
   - 侧边菜单能正确显示和折叠
   - 响应式布局适配良好

2. **导航功能验证**：
   - 面包屑导航正确显示
   - 菜单权限过滤正确
   - 用户信息展示完整

3. **用户体验验证**：
   - 主题切换功能正常
   - 全屏切换功能正常
   - 搜索功能可用

4. **状态管理验证**：
   - 应用状态能正确保存和恢复
   - 全局加载状态管理正常
   - 错误处理完善

#### 产出物清单
- ✓ src/layouts/DefaultLayout.vue（主布局组件）
- ✓ src/components/layout/SideMenu.vue（侧边菜单组件）
- ✓ src/components/layout/UserDropdown.vue（用户下拉菜单）
- ✓ src/stores/app.js（应用状态管理）
- ✓ 完整的布局框架系统
- ✓ 响应式设计和主题切换
- ✓ 权限控制的菜单系统

---

### T2.4.2 配置应用路由结构

#### 任务描述
1. **定义所有页面路由**：
   - 配置所有视图组件的路由路径
   - 设置路由懒加载
   - 配置路由元信息（权限、标题等）

2. **配置嵌套路由结构**：
   - 实现换热器→管段的嵌套路由
   - 配置系统管理的子路由
   - 设置错误页面的路由

3. **配置路由元信息**：
   - 设置页面标题和面包屑
   - 配置权限要求和角色限制
   - 设置图标和菜单显示配置

4. **配置路由懒加载**：
   - 实现按需加载视图组件
   - 配置加载状态显示
   - 设置加载失败处理

#### 技术细节与实现步骤

**步骤1：完善路由配置**
```javascript
// src/router/routes.js - 完整路由配置
import { PERMISSIONS } from '@/models/user'

/**
 * 基础路由（不需要权限验证）
 */
export const basicRoutes = [
  {
    path: '/login',
    name: 'login',
    component: () => import('@/views/Login.vue'),
    meta: {
      title: '登录',
      requiresAuth: false,
      hideLayout: true,
      suppressLoginPrompt: true
    }
  },
  {
    path: '/404',
    name: 'not-found',
    component: () => import('@/views/error/404.vue'),
    meta: {
      title: '页面不存在',
      requiresAuth: false,
      hideLayout: false
    }
  },
  {
    path: '/403',
    name: 'forbidden',
    component: () => import('@/views/error/403.vue'),
    meta: {
      title: '无权限访问',
      requiresAuth: false,
      hideLayout: false
    }
  }
]

/**
 * 异步路由（需要权限验证，动态加载）
 */
export const asyncRoutes = [
  {
    path: '/',
    redirect: '/dashboard',
    meta: {
      hideInMenu: true
    }
  },
  {
    path: '/dashboard',
    name: 'dashboard',
    component: () => import('@/views/Dashboard.vue'),
    meta: {
      title: '仪表盘',
      requiresAuth: true,
      roles: ['operator', 'engineer', 'admin'],
      permissions: [PERMISSIONS.VIEW_DASHBOARD],
      icon: 'dashboard',
      breadcrumb: ['首页']
    }
  },
  {
    path: '/heat-exchangers',
    name: 'heat-exchangers',
    component: () => import('@/views/HeatExchangers.vue'),
    meta: {
      title: '换热器列表',
      requiresAuth: true,
      roles: ['operator', 'engineer', 'admin'],
      permissions: [PERMISSIONS.VIEW_HEAT_EXCHANGERS],
      icon: 'heat-exchanger',
      breadcrumb: ['换热器管理']
    }
  },
  {
    path: '/heat-exchangers/:id',
    name: 'heat-exchanger-detail',
    component: () => import('@/views/HeatExchangerDetail.vue'),
    meta: {
      title: '换热器详情',
      requiresAuth: true,
      roles: ['operator', 'engineer', 'admin'],
      permissions: [PERMISSIONS.VIEW_HEAT_EXCHANGERS],
      icon: 'detail',
      breadcrumb: ['换热器管理', '详情']
    },
    props: true
  },
  {
    path: '/heat-exchangers/:heatExchangerId/sections/:sectionNumber',
    name: 'section-detail',
    component: () => import('@/views/SectionDetail.vue'),
    meta: {
      title: '管段详情',
      requiresAuth: true,
      roles: ['operator', 'engineer', 'admin'],
      permissions: [PERMISSIONS.VIEW_HEAT_EXCHANGERS],
      icon: 'section',
      breadcrumb: ['换热器管理', '管段详情']
    },
    props: true
  },
  {
    path: '/alerts',
    name: 'alerts',
    component: () => import('@/views/Alerts.vue'),
    meta: {
      title: '报警管理',
      requiresAuth: true,
      roles: ['operator', 'engineer', 'admin'],
      permissions: [PERMISSIONS.VIEW_ALERTS],
      icon: 'alert',
      breadcrumb: ['报警管理']
    },
    children: [
      {
        path: 'active',
        name: 'active-alerts',
        component: () => import('@/views/alerts/ActiveAlerts.vue'),
        meta: {
          title: '活跃报警',
          icon: 'warning',
          breadcrumb: ['报警管理', '活跃报警']
        }
      },
      {
        path: 'history',
        name: 'alert-history',
        component: () => import('@/views/alerts/AlertHistory.vue'),
        meta: {
          title: '历史报警',
          icon: 'clock',
          breadcrumb: ['报警管理', '历史报警']
        }
      },
      {
        path: 'rules',
        name: 'alert-rules',
        component: () => import('@/views/alerts/AlertRules.vue'),
        meta: {
          title: '报警规则',
          roles: ['engineer', 'admin'],
          permissions: [PERMISSIONS.MANAGE_HEAT_EXCHANGERS],
          icon: 'setting',
          breadcrumb: ['报警管理', '报警规则']
        }
      }
    ]
  },
  {
    path: '/reports',
    name: 'reports',
    component: () => import('@/views/Reports.vue'),
    meta: {
      title: '报表分析',
      requiresAuth: true,
      roles: ['engineer', 'admin'],
      permissions: [PERMISSIONS.VIEW_REPORTS],
      icon: 'document',
      breadcrumb: ['报表分析']
    },
    children: [
      {
        path: 'daily',
        name: 'daily-reports',
        component: () => import('@/views/reports/DailyReports.vue'),
        meta: {
          title: '日报表',
          icon: 'calendar',
          breadcrumb: ['报表分析', '日报表']
        }
      },
      {
        path: 'weekly',
        name: 'weekly-reports',
        component: () => import('@/views/reports/WeeklyReports.vue'),
        meta: {
          title: '周报表',
          icon: 'data-line',
          breadcrumb: ['报表分析', '周报表']
        }
      },
      {
        path: 'monthly',
        name: 'monthly-reports',
        component: () => import('@/views/reports/MonthlyReports.vue'),
        meta: {
          title: '月报表',
          icon: 'pie-chart',
          breadcrumb: ['报表分析', '月报表']
        }
      },
      {
        path: 'custom',
        name: 'custom-reports',
        component: () => import('@/views/reports/CustomReports.vue'),
        meta: {
          title: '自定义报表',
          icon: 'set-up',
          breadcrumb: ['报表分析', '自定义报表']
        }
      }
    ]
  },
  {
    path: '/system',
    name: 'system',
    component: () => import('@/views/System.vue'),
    meta: {
      title: '系统管理',
      requiresAuth: true,
      roles: ['admin'],
      permissions: [PERMISSIONS.MANAGE_SYSTEM_SETTINGS],
      icon: 'setting',
      breadcrumb: ['系统管理']
    },
    children: [
      {
        path: 'users',
        name: 'user-management',
        component: () => import('@/views/system/UserManagement.vue'),
        meta: {
          title: '用户管理',
          permissions: [PERMISSIONS.MANAGE_USERS],
          icon: 'user',
          breadcrumb: ['系统管理', '用户管理']
        }
      },
      {
        path: 'roles',
        name: 'role-management',
        component: () => import('@/views/system/RoleManagement.vue'),
        meta: {
          title: '角色管理',
          permissions: [PERMISSIONS.MANAGE_ROLES],
          icon: 'user-filled',
          breadcrumb: ['系统管理', '角色管理']
        }
      },
      {
        path: 'logs',
        name: 'system-logs',
        component: () => import('@/views/system/SystemLogs.vue'),
        meta: {
          title: '系统日志',
          permissions: [PERMISSIONS.VIEW_SYSTEM_LOGS],
          icon: 'document',
          breadcrumb: ['系统管理', '系统日志']
        }
      },
      {
        path: 'audit-logs',
        name: 'audit-logs',
        component: () => import('@/views/system/AuditLogs.vue'),
        meta: {
          title: '审计日志',
          permissions: [PERMISSIONS.VIEW_AUDIT_LOGS],
          icon: 'audit',
          breadcrumb: ['系统管理', '审计日志']
        }
      },
      {
        path: 'settings',
        name: 'system-settings',
        component: () => import('@/views/system/SystemSettings.vue'),
        meta: {
          title: '系统设置',
          permissions: [PERMISSIONS.MANAGE_SYSTEM_SETTINGS],
          icon: 'tools',
          breadcrumb: ['系统管理', '系统设置']
        }
      }
    ]
  },
  {
    path: '/profile',
    name: 'profile',
    component: () => import('@/views/Profile.vue'),
    meta: {
      title: '个人中心',
      requiresAuth: true,
      roles: ['operator', 'engineer', 'admin'],
      icon: 'user',
      breadcrumb: ['个人中心']
    },
    children: [
      {
        path: 'settings',
        name: 'profile-settings',
        component: () => import('@/views/profile/ProfileSettings.vue'),
        meta: {
          title: '账户设置',
          breadcrumb: ['个人中心', '账户设置']
        }
      },
      {
        path: 'notifications',
        name: 'profile-notifications',
        component: () => import('@/views/profile/NotificationSettings.vue'),
        meta: {
          title: '消息设置',
          breadcrumb: ['个人中心', '消息设置']
        }
      },
      {
        path: 'security',
        name: 'profile-security',
        component: () => import('@/views/profile/SecuritySettings.vue'),
        meta: {
          title: '安全设置',
          breadcrumb: ['个人中心', '安全设置']
        }
      }
    ]
  }
]

/**
 * 错误路由（最后匹配）
 */
export const errorRoutes = [
  {
    path: '/:pathMatch(.*)*',
    redirect: '/404'
  }
]

/**
 * 所有路由合并
 */
export const routes = [
  ...basicRoutes,
  ...asyncRoutes,
  ...errorRoutes
]

/**
 * 根据用户权限获取可访问的路由
 */
export function getAccessibleRoutes(userPermissions) {
  return asyncRoutes.filter(route => {
    if (!route.meta || !route.meta.permissions) {
      return true
    }
    
    const requiredPermissions = route.meta.permissions
    if (Array.isArray(requiredPermissions)) {
      return requiredPermissions.some(permission => 
        userPermissions.includes(permission)
      )
    }
    
    return userPermissions.includes(requiredPermissions)
  })
}
```

**步骤2：配置路由懒加载优化**
```javascript
// src/router/index.js - 优化版本
import { createRouter, createWebHistory } from 'vue-router'
import { routes, getAccessibleRoutes } from './routes'
import { beforeEachGuard, afterEachGuard } from './guards'
import { useAuthStore } from '@/stores/auth'

// 创建路由实例
const router = createRouter({
  history: createWebHistory(),
  routes,
  
  // 滚动行为
  scrollBehavior(to, from, savedPosition) {
    if (savedPosition) {
      return savedPosition
    } else {
      return { top: 0 }
    }
  }
})

// 动态添加路由
let isDynamicRoutesAdded = false

/**
 * 动态添加权限路由
 */
export async function addDynamicRoutes() {
  if (isDynamicRoutesAdded) return
  
  const authStore = useAuthStore()
  
  if (!authStore.isAuthenticated) {
    return
  }
  
  try {
    // 获取用户权限
    const userPermissions = authStore.user?.permissions || []
    
    // 获取可访问的路由
    const accessibleRoutes = getAccessibleRoutes(userPermissions)
    
    // 动态添加路由
    accessibleRoutes.forEach(route => {
      if (!router.hasRoute(route.name)) {
        router.addRoute(route)
      }
    })
    
    isDynamicRoutesAdded = true
    console.log('动态路由添加完成')
  } catch (error) {
    console.error('动态添加路由失败:', error)
  }
}

/**
 * 重置动态路由
 */
export function resetDynamicRoutes() {
  // 获取所有路由名称
  const routeNames = router.getRoutes()
    .map(route => route.name)
    .filter(name => name && !['login', '404', '403'].includes(name))
  
  // 移除所有动态添加的路由
  routeNames.forEach(name => {
    router.removeRoute(name)
  })
  
  isDynamicRoutesAdded = false
  console.log('动态路由已重置')
}

/**
 * 路由加载失败处理
 */
function loadComponent(componentPath) {
  return () => import(/* @vite-ignore */ componentPath)
    .catch(error => {
      console.error(`组件加载失败: ${componentPath}`, error)
      
      // 返回错误组件
      return import('@/views/error/LoadError.vue')
    })
}

/**
 * 包装懒加载组件，添加加载状态
 */
function lazyLoadView(componentPath, loadingComponent = null) {
  const AsyncComponent = () => ({
    component: loadComponent(componentPath),
    
    // 加载中显示的组件
    loading: loadingComponent || {
      template: '<div class="loading-container"><div class="loading-spinner"></div></div>'
    },
    
    // 加载失败显示的组件
    error: {
      template: '<div class="error-container">组件加载失败</div>'
    },
    
    // 延迟显示加载组件的时间（默认200ms）
    delay: 200,
    
    // 超时时间（默认10秒）
    timeout: 10000
  })
  
  return AsyncComponent
}

// 注册全局前置守卫
router.beforeEach(async (to, from, next) => {
  // 动态添加路由（如果需要）
  if (to.meta.requiresAuth && !isDynamicRoutesAdded) {
    await addDynamicRoutes()
  }
  
  // 执行权限守卫
  return beforeEachGuard(to, from, next)
})

// 注册全局后置钩子
router.afterEach(afterEachGuard)

// 导出路由实例
export default router

// 导出路由工具函数
export {
  addDynamicRoutes,
  resetDynamicRoutes,
  getAccessibleRoutes
}
```

**步骤3：创建路由加载状态组件**
```vue
<!-- src/components/common/RouteLoading.vue -->
<template>
  <div class="route-loading">
    <div class="loading-content">
      <!-- 加载动画 -->
      <div class="loading-spinner">
        <div class="spinner-ring"></div>
        <div class="spinner-ring"></div>
        <div class="spinner-ring"></div>
        <div class="spinner-ring"></div>
      </div>
      
      <!-- 加载文本 -->
      <div class="loading-text">
        {{ loadingText }}
      </div>
      
      <!-- 进度条 -->
      <div class="loading-progress" v-if="showProgress">
        <div class="progress-bar">
          <div 
            class="progress-fill" 
            :style="{ width: progress + '%' }"
          />
        </div>
        <div class="progress-text">{{ progress }}%</div>
      </div>
      
      <!-- 加载提示 -->
      <div class="loading-tips" v-if="showTips">
        <p>正在加载页面资源，请稍候...</p>
        <p class="tip-small">如果长时间未加载完成，请检查网络连接</p>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted, onUnmounted } from 'vue'

const props = defineProps({
  loadingText: {
    type: String,
    default: '加载中...'
  },
  showProgress: {
    type: Boolean,
    default: true
  },
  showTips: {
    type: Boolean,
    default: true
  },
  timeout: {
    type: Number,
    default: 10000 // 10秒超时
  }
})

const progress = ref(0)
const isTimedOut = ref(false)
let progressInterval
let timeoutTimer

// 模拟进度更新
function startProgress() {
  progressInterval = setInterval(() => {
    if (progress.value < 90) {
      progress.value += Math.random() * 10
    }
  }, 200)
}

// 清理定时器
function cleanupTimers() {
  if (progressInterval) {
    clearInterval(progressInterval)
  }
  if (timeoutTimer) {
    clearTimeout(timeoutTimer)
  }
}

// 完成加载
function finishLoading() {
  progress.value = 100
  cleanupTimers()
}

// 超时处理
function handleTimeout() {
  isTimedOut.value = true
  cleanupTimers()
}

// 生命周期
onMounted(() => {
  startProgress()
  
  // 设置超时定时器
  timeoutTimer = setTimeout(handleTimeout, props.timeout)
})

onUnmounted(() => {
  cleanupTimers()
})

// 暴露方法给父组件
defineExpose({
  finishLoading
})
</script>

<style scoped lang="scss">
@import '@/assets/styles/variables.scss';

.route-loading {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(white, 0.95);
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(5px);
}

.loading-content {
  text-align: center;
  max-width: 400px;
  padding: 40px;
  background: white;
  border-radius: 16px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
}

.loading-spinner {
  display: inline-block;
  position: relative;
  width: 80px;
  height: 80px;
  margin-bottom: 24px;

  .spinner-ring {
    box-sizing: border-box;
    display: block;
    position: absolute;
    width: 64px;
    height: 64px;
    margin: 8px;
    border: 6px solid color(primary);
    border-radius: 50%;
    animation: spinner-ring 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
    border-color: color(primary) transparent transparent transparent;

    &:nth-child(1) {
      animation-delay: -0.45s;
    }

    &:nth-child(2) {
      animation-delay: -0.3s;
    }

    &:nth-child(3) {
      animation-delay: -0.15s;
    }
  }
}

@keyframes spinner-ring {
  0% {
    transform: rotate(0deg);
  }
  100% {
    transform: rotate(360deg);
  }
}

.loading-text {
  font-size: 18px;
  font-weight: 500;
  color: color(gray-700);
  margin-bottom: 20px;
}

.loading-progress {
  margin: 20px 0;
  
  .progress-bar {
    width: 100%;
    height: 6px;
    background: color(gray-200);
    border-radius: 3px;
    overflow: hidden;
    margin-bottom: 8px;
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, color(primary) 0%, lighten(color(primary), 20%) 100%);
      border-radius: 3px;
      transition: width 0.3s ease;
    }
  }
  
  .progress-text {
    font-size: 14px;
    color: color(gray-600);
  }
}

.loading-tips {
  margin-top: 24px;
  padding-top: 20px;
  border-top: 1px solid color(gray-200);
  
  p {
    margin: 4px 0;
    color: color(gray-600);
    font-size: 14px;
    
    &.tip-small {
      font-size: 12px;
      color: color(gray-500);
    }
  }
}
</style>
```

#### 验收条件
1. **路由配置验证**：
   - 所有路由能正常访问
   - 路由懒加载工作正常
   - 嵌套路由显示正确

2. **权限路由验证**：
   - 动态路由能根据权限正确添加
   - 无权限路由无法访问
   - 权限变更后路由能正确更新

3. **用户体验验证**：
   - 路由加载状态显示良好
   - 页面切换过渡流畅
   - 加载失败有友好提示

4. **性能验证**：
   - 路由懒加载能有效减少初始包大小
   - 动态路由添加不影响性能
   - 路由切换无卡顿

#### 产出物清单
- ✓ src/router/routes.js（完整路由配置）
- ✓ src/router/index.js（路由实例配置）
- ✓ src/components/common/RouteLoading.vue（路由加载组件）
- ✓ 完整的路由导航系统
- ✓ 动态路由权限控制
- ✓ 路由懒加载和加载状态管理

---

## 模块完成标准

### 总体验收条件
1. **布局框架完整**：
   - 主布局组件能正确渲染所有页面
   - 响应式布局适配各种屏幕尺寸
   - 主题切换功能正常工作

2. **导航系统完善**：
   - 侧边菜单能正确显示和导航
   - 面包屑导航准确显示当前位置
   - 用户菜单功能完整

3. **路由配置正确**：
   - 所有页面路由能正常访问
   - 权限路由控制准确
   - 嵌套路由结构清晰

4. **用户体验优秀**：
   - 页面切换过渡流畅
   - 加载状态显示友好
   - 错误处理完善

### 产出物总览
- ✓ 完整的应用布局框架
- ✓ 响应式导航系统
- ✓ 权限控制的路由配置
- ✓ 主题切换和个性化设置
- ✓ 优秀的用户体验设计

### 下一模块准备
完成本模块后，项目已具备：
1. 完整的应用界面框架
2. 响应式的导航系统
3. 权限控制的路由结构
4. 良好的用户体验基础

可以进入下一模块：换热器管理模块开发