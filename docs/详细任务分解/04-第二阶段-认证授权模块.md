# 第二阶段：认证授权模块 - 详细任务分解

**阶段目标**：实现完整的用户认证和授权系统，包括Pinia状态管理、登录页面组件和路由权限守卫  
**预估工期**：4人日  
**关键产出**：完整可用的认证系统，支持用户登录、Token管理、权限验证和路由保护

---

## 任务清单

### T2.3.1 创建Pinia认证Store

#### 任务描述
1. **定义认证状态结构**：
   - 用户信息、Token、权限列表等状态定义
   - 登录状态、加载状态等辅助状态

2. **实现认证Actions**：
   - 登录、注销、Token刷新等异步操作
   - 用户信息获取和更新
   - 权限验证和检查

3. **配置状态持久化**：
   - 状态自动保存到localStorage
   - Token安全存储
   - 状态恢复和初始化

#### 技术细节与实现步骤

**步骤1：创建用户模型**
```javascript
// src/models/user.js
/**
 * 用户数据模型
 */

export class User {
  constructor(data = {}) {
    this.id = data.id || null
    this.username = data.username || ''
    this.email = data.email || ''
    this.displayName = data.display_name || data.username || ''
    this.avatar = data.avatar || null
    this.role = data.role || 'operator' // operator, engineer, admin
    this.permissions = data.permissions || []
    this.assignedHeatExchangers = data.assigned_heat_exchangers || []
    this.createdAt = data.created_at ? new Date(data.created_at) : null
    this.lastLogin = data.last_login ? new Date(data.last_login) : null
    
    // 扩展字段
    this.department = data.department || ''
    this.position = data.position || ''
    this.phone = data.phone || ''
    this.status = data.status || 'active' // active, inactive, blocked
  }
  
  /**
   * 检查是否有特定权限
   */
  hasPermission(permission) {
    if (this.role === 'admin') {
      return true // 管理员拥有所有权限
    }
    
    return this.permissions.includes(permission)
  }
  
  /**
   * 检查是否有任意权限
   */
  hasAnyPermission(permissions) {
    if (this.role === 'admin') {
      return true
    }
    
    return permissions.some(permission => this.permissions.includes(permission))
  }
  
  /**
   * 检查是否拥有所有权限
   */
  hasAllPermissions(permissions) {
    if (this.role === 'admin') {
      return true
    }
    
    return permissions.every(permission => this.permissions.includes(permission))
  }
  
  /**
   * 检查是否可以查看特定换热器
   */
  canViewHeatExchanger(heatExchangerId) {
    if (this.role === 'admin' || this.role === 'engineer') {
      return true // 管理员和工程师可以查看所有换热器
    }
    
    return this.assignedHeatExchangers.includes(heatExchangerId)
  }
  
  /**
   * 获取角色显示名称
   */
  getRoleDisplayName() {
    const roleNames = {
      'operator': '操作员',
      'engineer': '工程师',
      'admin': '管理员'
    }
    
    return roleNames[this.role] || this.role
  }
  
  /**
   * 获取角色颜色
   */
  getRoleColor() {
    const roleColors = {
      'operator': 'primary',
      'engineer': 'success',
      'admin': 'warning'
    }
    
    return roleColors[this.role] || 'default'
  }
  
  /**
   * 检查用户是否在线（最近24小时内有活动）
   */
  isOnline() {
    if (!this.lastLogin) {
      return false
    }
    
    const now = new Date()
    const hoursSinceLastLogin = (now - this.lastLogin) / (1000 * 60 * 60)
    return hoursSinceLastLogin < 24
  }
}

/**
 * 权限常量定义
 */
export const PERMISSIONS = {
  // 查看权限
  VIEW_DASHBOARD: 'view_dashboard',
  VIEW_HEAT_EXCHANGERS: 'view_heat_exchangers',
  VIEW_ALERTS: 'view_alerts',
  VIEW_REPORTS: 'view_reports',
  VIEW_SYSTEM_LOGS: 'view_system_logs',
  
  // 操作权限
  MANAGE_HEAT_EXCHANGERS: 'manage_heat_exchangers',
  ACKNOWLEDGE_ALERTS: 'acknowledge_alerts',
  EXPORT_DATA: 'export_data',
  REPROCESS_DATA: 'reprocess_data',
  
  // 管理权限
  MANAGE_USERS: 'manage_users',
  MANAGE_ROLES: 'manage_roles',
  MANAGE_SYSTEM_SETTINGS: 'manage_system_settings',
  VIEW_AUDIT_LOGS: 'view_audit_logs'
}

/**
 * 角色权限映射
 */
export const ROLE_PERMISSIONS = {
  operator: [
    PERMISSIONS.VIEW_DASHBOARD,
    PERMISSIONS.VIEW_HEAT_EXCHANGERS,
    PERMISSIONS.VIEW_ALERTS,
    PERMISSIONS.ACKNOWLEDGE_ALERTS,
    PERMISSIONS.EXPORT_DATA
  ],
  
  engineer: [
    PERMISSIONS.VIEW_DASHBOARD,
    PERMISSIONS.VIEW_HEAT_EXCHANGERS,
    PERMISSIONS.VIEW_ALERTS,
    PERMISSIONS.VIEW_REPORTS,
    PERMISSIONS.ACKNOWLEDGE_ALERTS,
    PERMISSIONS.EXPORT_DATA,
    PERMISSIONS.REPROCESS_DATA,
    PERMISSIONS.MANAGE_HEAT_EXCHANGERS
  ],
  
  admin: Object.values(PERMISSIONS) // 管理员拥有所有权限
}
```

**步骤2：创建认证Store**
```javascript
// src/stores/auth.js
import { defineStore } from 'pinia'
import { User, PERMISSIONS, ROLE_PERMISSIONS } from '@/models/user'
import { authAPI } from '@/api/auth'
import { storageUtils } from '@/utils/storage'

/**
 * 认证状态管理Store
 */
export const useAuthStore = defineStore('auth', {
  state: () => ({
    // 认证状态
    isAuthenticated: false,
    isLoading: false,
    error: null,
    
    // 用户信息
    user: null,
    
    // Token信息
    accessToken: null,
    refreshToken: null,
    tokenExpiry: null,
    
    // 权限信息
    permissions: [],
    
    // 登录重定向
    redirectPath: null,
    
    // 登录历史
    loginHistory: []
  }),
  
  getters: {
    /**
     * 获取当前用户（只读）
     */
    currentUser: (state) => state.user,
    
    /**
     * 获取Token（只读）
     */
    token: (state) => state.accessToken,
    
    /**
     * 检查是否已登录
     */
    isLoggedIn: (state) => state.isAuthenticated && state.user !== null,
    
    /**
     * 获取用户角色
     */
    userRole: (state) => state.user?.role || null,
    
    /**
     * 获取用户显示名称
     */
    userDisplayName: (state) => state.user?.displayName || '',
    
    /**
     * 获取用户头像
     */
    userAvatar: (state) => state.user?.avatar || null,
    
    /**
     * 检查是否有特定权限
     */
    hasPermission: (state) => (permission) => {
      if (!state.user) return false
      return state.user.hasPermission(permission)
    },
    
    /**
     * 检查是否有任意权限
     */
    hasAnyPermission: (state) => (permissions) => {
      if (!state.user) return false
      return state.user.hasAnyPermission(permissions)
    },
    
    /**
     * 检查是否可以查看换热器
     */
    canViewHeatExchanger: (state) => (heatExchangerId) => {
      if (!state.user) return false
      return state.user.canViewHeatExchanger(heatExchangerId)
    },
    
    /**
     * 检查Token是否即将过期（15分钟内过期）
     */
    isTokenExpiringSoon: (state) => {
      if (!state.tokenExpiry) return false
      
      const now = new Date()
      const expiryTime = new Date(state.tokenExpiry)
      const fifteenMinutes = 15 * 60 * 1000
      
      return expiryTime - now < fifteenMinutes
    },
    
    /**
     * 获取登录状态文本
     */
    loginStatusText: (state) => {
      if (state.isLoading) return '登录中...'
      if (state.error) return `登录失败: ${state.error}`
      if (state.isAuthenticated) return `已登录为 ${state.user?.displayName}`
      return '未登录'
    }
  },
  
  actions: {
    /**
     * 初始化认证状态（从localStorage恢复）
     */
    async initializeAuth() {
      this.isLoading = true
      
      try {
        // 从localStorage恢复Token
        const savedAccessToken = storageUtils.getString('access_token')
        const savedRefreshToken = storageUtils.getString('refresh_token')
        const savedUser = storageUtils.getObject('user')
        const savedTokenExpiry = storageUtils.getString('token_expiry')
        
        if (savedAccessToken && savedUser) {
          this.accessToken = savedAccessToken
          this.refreshToken = savedRefreshToken
          this.tokenExpiry = savedTokenExpiry ? new Date(savedTokenExpiry) : null
          this.user = new User(savedUser)
          this.isAuthenticated = true
          
          // 验证Token是否有效
          const isValid = await this.validateToken()
          if (!isValid) {
            await this.clearAuth()
          }
        }
      } catch (error) {
        console.error('初始化认证状态失败:', error)
        await this.clearAuth()
      } finally {
        this.isLoading = false
      }
    },
    
    /**
     * 用户登录
     */
    async login(credentials) {
      this.isLoading = true
      this.error = null
      
      try {
        // 调用登录API
        const response = await authAPI.login(credentials)
        
        // 保存Token和用户信息
        this.accessToken = response.access_token
        this.refreshToken = response.refresh_token
        this.tokenExpiry = new Date(Date.now() + response.expires_in * 1000)
        this.user = new User(response.user)
        this.isAuthenticated = true
        
        // 保存到localStorage
        this.saveAuthToStorage()
        
        // 添加登录记录
        this.addLoginHistory({
          timestamp: new Date(),
          ip: response.ip_address,
          userAgent: navigator.userAgent,
          success: true
        })
        
        // 返回成功结果
        return {
          success: true,
          user: this.user,
          redirect: this.redirectPath || '/dashboard'
        }
        
      } catch (error) {
        this.error = error.message || '登录失败'
        
        // 添加失败的登录记录
        this.addLoginHistory({
          timestamp: new Date(),
          username: credentials.username,
          success: false,
          error: error.message
        })
        
        return {
          success: false,
          error: this.error
        }
      } finally {
        this.isLoading = false
      }
    },
    
    /**
     * 用户注销
     */
    async logout() {
      this.isLoading = true
      
      try {
        // 调用注销API（如果有）
        if (this.accessToken) {
          try {
            await authAPI.logout(this.accessToken)
          } catch (error) {
            console.warn('注销API调用失败:', error)
            // 继续执行本地注销
          }
        }
        
        // 清除本地认证状态
        await this.clearAuth()
        
        // 添加注销记录
        this.addLoginHistory({
          timestamp: new Date(),
          action: 'logout',
          success: true
        })
        
        return { success: true }
      } catch (error) {
        console.error('注销失败:', error)
        return { success: false, error: error.message }
      } finally {
        this.isLoading = false
      }
    },
    
    /**
     * 刷新Token
     */
    async refreshAccessToken() {
      if (!this.refreshToken) {
        throw new Error('没有可用的刷新Token')
      }
      
      try {
        const response = await authAPI.refreshToken(this.refreshToken)
        
        // 更新Token信息
        this.accessToken = response.access_token
        this.refreshToken = response.refresh_token || this.refreshToken
        this.tokenExpiry = new Date(Date.now() + response.expires_in * 1000)
        
        // 保存到localStorage
        this.saveAuthToStorage()
        
        return { success: true }
      } catch (error) {
        console.error('刷新Token失败:', error)
        
        // 刷新失败，清除认证状态
        await this.clearAuth()
        
        throw error
      }
    },
    
    /**
     * 验证Token有效性
     */
    async validateToken() {
      if (!this.accessToken) {
        return false
      }
      
      try {
        // 检查Token是否过期
        if (this.tokenExpiry && new Date() > this.tokenExpiry) {
          // Token已过期，尝试刷新
          try {
            await this.refreshAccessToken()
            return true
          } catch {
            return false
          }
        }
        
        // 调用验证API（可选）
        // const isValid = await authAPI.validateToken(this.accessToken)
        // return isValid
        
        // 暂时认为有效
        return true
      } catch (error) {
        console.error('验证Token失败:', error)
        return false
      }
    },
    
    /**
     * 更新用户信息
     */
    async updateUserInfo() {
      if (!this.isAuthenticated) {
        return
      }
      
      try {
        const userInfo = await authAPI.getUserInfo()
        this.user = new User(userInfo)
        
        // 更新localStorage
        storageUtils.setObject('user', this.user)
      } catch (error) {
        console.error('更新用户信息失败:', error)
      }
    },
    
    /**
     * 清除认证状态
     */
    async clearAuth() {
      // 清除state
      this.isAuthenticated = false
      this.user = null
      this.accessToken = null
      this.refreshToken = null
      this.tokenExpiry = null
      this.permissions = []
      this.error = null
      
      // 清除localStorage
      storageUtils.removeItem('access_token')
      storageUtils.removeItem('refresh_token')
      storageUtils.removeItem('user')
      storageUtils.removeItem('token_expiry')
      
      // 清除其他相关存储
      storageUtils.removeItem('auth_redirect')
    },
    
    /**
     * 保存认证状态到localStorage
     */
    saveAuthToStorage() {
      if (!this.isAuthenticated || !this.user) {
        return
      }
      
      storageUtils.setString('access_token', this.accessToken)
      storageUtils.setString('refresh_token', this.refreshToken)
      storageUtils.setObject('user', this.user)
      
      if (this.tokenExpiry) {
        storageUtils.setString('token_expiry', this.tokenExpiry.toISOString())
      }
    },
    
    /**
     * 设置重定向路径
     */
    setRedirectPath(path) {
      this.redirectPath = path
      if (path) {
        storageUtils.setString('auth_redirect', path)
      } else {
        storageUtils.removeItem('auth_redirect')
      }
    },
    
    /**
     * 获取重定向路径
     */
    getRedirectPath() {
      return this.redirectPath || storageUtils.getString('auth_redirect') || '/dashboard'
    },
    
    /**
     * 清除重定向路径
     */
    clearRedirectPath() {
      this.redirectPath = null
      storageUtils.removeItem('auth_redirect')
    },
    
    /**
     * 添加登录历史记录
     */
    addLoginHistory(record) {
      this.loginHistory.unshift({
        id: Date.now(),
        ...record
      })
      
      // 只保留最近20条记录
      if (this.loginHistory.length > 20) {
        this.loginHistory.pop()
      }
      
      // 保存到localStorage（可选）
      storageUtils.setArray('login_history', this.loginHistory.slice(0, 10))
    },
    
    /**
     * 获取登录历史
     */
    getLoginHistory(limit = 10) {
      const savedHistory = storageUtils.getArray('login_history', [])
      const combinedHistory = [...this.loginHistory, ...savedHistory]
      
      // 去重并按时间排序
      const uniqueHistory = Array.from(
        new Map(combinedHistory.map(item => [item.id, item])).values()
      )
        .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
        .slice(0, limit)
      
      return uniqueHistory
    }
  },
  
  /**
   * 状态持久化配置
   */
  persist: {
    key: 'heat_exchanger_auth',
    storage: localStorage,
    paths: [
      'isAuthenticated',
      'user',
      'accessToken',
      'refreshToken',
      'tokenExpiry',
      'permissions',
      'loginHistory'
    ],
    
    // 自定义序列化/反序列化
    serializer: {
      serialize: JSON.stringify,
      deserialize: JSON.parse
    },
    
    // 状态恢复时的钩子
    beforeRestore: (context) => {
      console.log('正在恢复认证状态...')
    },
    
    afterRestore: (context) => {
      console.log('认证状态恢复完成')
    }
  }
})
```

**步骤3：创建认证API模块**
```javascript
// src/api/auth.js
import { http } from '@/utils/request'

/**
 * 认证相关API接口
 */
export const authAPI = {
  /**
   * 用户登录
   * @param {Object} credentials - 登录凭证
   * @returns {Promise} 登录结果
   */
  login(credentials) {
    return http.post('/api/auth/login', credentials)
  },
  
  /**
   * 用户注销
   * @param {string} token - 访问令牌
   * @returns {Promise} 注销结果
   */
  logout(token) {
    return http.post('/api/auth/logout', { token })
  },
  
  /**
   * 刷新访问令牌
   * @param {string} refreshToken - 刷新令牌
   * @returns {Promise} 新的令牌信息
   */
  refreshToken(refreshToken) {
    return http.post('/api/auth/refresh', { refresh_token: refreshToken })
  },
  
  /**
   * 验证令牌有效性
   * @param {string} token - 访问令牌
   * @returns {Promise} 验证结果
   */
  validateToken(token) {
    return http.post('/api/auth/validate', { token })
  },
  
  /**
   * 获取用户信息
   * @returns {Promise} 用户信息
   */
  getUserInfo() {
    return http.get('/api/auth/user')
  },
  
  /**
   * 更新用户信息
   * @param {Object} userData - 用户数据
   * @returns {Promise} 更新结果
   */
  updateUserInfo(userData) {
    return http.put('/api/auth/user', userData)
  },
  
  /**
   * 修改密码
   * @param {Object} passwordData - 密码数据
   * @returns {Promise} 修改结果
   */
  changePassword(passwordData) {
    return http.post('/api/auth/change-password', passwordData)
  },
  
  /**
   * 重置密码请求
   * @param {Object} resetData - 重置数据
   * @returns {Promise} 重置结果
   */
  requestPasswordReset(resetData) {
    return http.post('/api/auth/reset-password', resetData)
  },
  
  /**
   * 验证重置密码令牌
   * @param {Object} tokenData - 令牌数据
   * @returns {Promise} 验证结果
   */
  verifyResetToken(tokenData) {
    return http.post('/api/auth/verify-reset-token', tokenData)
  },
  
  /**
   * 获取用户权限列表
   * @returns {Promise} 权限列表
   */
  getUserPermissions() {
    return http.get('/api/auth/permissions')
  },
  
  /**
   * 获取用户分配的换热器
   * @returns {Promise} 换热器列表
   */
  getAssignedHeatExchangers() {
    return http.get('/api/auth/assigned-heat-exchangers')
  },
  
  /**
   * 获取登录历史
   * @param {Object} params - 查询参数
   * @returns {Promise} 登录历史
   */
  getLoginHistory(params = {}) {
    return http.get('/api/auth/login-history', params)
  }
}

export default authAPI
```

#### 验收条件
1. **状态管理验证**：
   - Pinia Store能正确管理认证状态
   - 状态变更能正确触发组件更新
   - 状态能正确持久化到localStorage

2. **认证功能验证**：
   - 登录、注销功能正常工作
   - Token刷新机制有效
   - 用户信息能正确获取和更新

3. **权限管理验证**：
   - 权限检查功能正确
   - 角色权限映射准确
   - 换热器访问控制有效

4. **数据持久化验证**：
   - 认证状态能正确保存和恢复
   - Token安全存储
   - 登录历史记录完整

#### 产出物清单
- ✓ src/models/user.js（用户数据模型）
- ✓ src/stores/auth.js（认证状态管理）
- ✓ src/api/auth.js（认证API接口）
- ✓ 完整的用户认证系统
- ✓ 权限管理和角色系统
- ✓ 状态持久化和恢复机制

---

### T2.3.2 实现登录页面组件

#### 任务描述
1. **创建登录页面UI**：
   - 设计登录表单布局
   - 实现表单验证逻辑
   - 添加记住我、忘记密码等功能

2. **集成登录API调用**：
   - 连接认证Store的登录action
   - 处理登录成功/失败场景
   - 实现登录后跳转逻辑

3. **实现用户体验优化**：
   - 加载状态显示
   - 错误提示处理
   - 键盘导航支持

#### 技术细节与实现步骤

**步骤1：创建登录页面组件**
```vue
<!-- src/views/Login.vue -->
<template>
  <div class="login-container">
    <!-- 背景装饰 -->
    <div class="login-background">
      <div class="background-pattern"></div>
      <div class="background-overlay"></div>
    </div>
    
    <!-- 主登录区域 -->
    <div class="login-main">
      <!-- 左侧品牌区域 -->
      <div class="login-brand">
        <div class="brand-logo">
          <svg class="logo-icon" viewBox="0 0 24 24">
            <path d="M12,2L4,6V18L12,22L20,18V6L12,2Z" fill="currentColor" />
            <path d="M12,10L8,12V16L12,18L16,16V12L12,10Z" fill="currentColor" opacity="0.7" />
          </svg>
          <span class="brand-name">换热器监测系统</span>
        </div>
        
        <div class="brand-slogan">
          <h1>工业换热器智能监测平台</h1>
          <p>实时监控 · 智能分析 · 预测维护</p>
        </div>
        
        <div class="brand-features">
          <div class="feature-item">
            <div class="feature-icon">
              <el-icon><Monitor /></el-icon>
            </div>
            <div class="feature-content">
              <h3>实时监控</h3>
              <p>7x24小时不间断监测换热器运行状态</p>
            </div>
          </div>
          
          <div class="feature-item">
            <div class="feature-icon">
              <el-icon><TrendCharts /></el-icon>
            </div>
            <div class="feature-content">
              <h3>数据分析</h3>
              <p>智能分析性能趋势，预测潜在故障</p>
            </div>
          </div>
          
          <div class="feature-item">
            <div class="feature-icon">
              <el-icon><Bell /></el-icon>
            </div>
            <div class="feature-content">
              <h3>智能报警</h3>
              <p>异常情况即时报警，保障生产安全</p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 右侧登录表单 -->
      <div class="login-form-container">
        <div class="form-wrapper">
          <!-- 表单标题 -->
          <div class="form-header">
            <h2>用户登录</h2>
            <p>请输入您的账号密码登录系统</p>
          </div>
          
          <!-- 登录表单 -->
          <el-form
            ref="loginFormRef"
            :model="loginForm"
            :rules="loginRules"
            label-width="0"
            class="login-form"
            @keyup.enter="handleLogin"
          >
            <!-- 用户名输入 -->
            <el-form-item prop="username">
              <el-input
                v-model="loginForm.username"
                placeholder="请输入用户名"
                size="large"
                :prefix-icon="User"
                autocomplete="username"
                autofocus
              />
            </el-form-item>
            
            <!-- 密码输入 -->
            <el-form-item prop="password">
              <el-input
                v-model="loginForm.password"
                type="password"
                placeholder="请输入密码"
                size="large"
                :prefix-icon="Lock"
                autocomplete="current-password"
                show-password
              />
            </el-form-item>
            
            <!-- 验证码（可选） -->
            <el-form-item v-if="showCaptcha" prop="captcha">
              <div class="captcha-container">
                <el-input
                  v-model="loginForm.captcha"
                  placeholder="请输入验证码"
                  size="large"
                  :prefix-icon="Key"
                  class="captcha-input"
                />
                <div class="captcha-image" @click="refreshCaptcha">
                  <img :src="captchaImage" alt="验证码" v-if="captchaImage" />
                  <div class="captcha-placeholder" v-else>
                    <el-icon><Picture /></el-icon>
                  </div>
                </div>
              </div>
            </el-form-item>
            
            <!-- 记住我和忘记密码 -->
            <div class="form-options">
              <div class="remember-me">
                <el-checkbox v-model="loginForm.rememberMe">记住我</el-checkbox>
              </div>
              <div class="forgot-password">
                <el-button type="text" @click="handleForgotPassword">
                  忘记密码？
                </el-button>
              </div>
            </div>
            
            <!-- 登录按钮 -->
            <el-form-item>
              <el-button
                type="primary"
                size="large"
                :loading="loading"
                @click="handleLogin"
                class="login-button"
              >
                {{ loading ? '登录中...' : '登录' }}
              </el-button>
            </el-form-item>
            
            <!-- 错误提示 -->
            <div v-if="errorMessage" class="error-message">
              <el-alert
                :title="errorMessage"
                type="error"
                :closable="true"
                @close="errorMessage = ''"
                show-icon
              />
            </div>
            
            <!-- 其他登录方式 -->
            <div class="alternative-login">
              <div class="divider">
                <span>其他登录方式</span>
              </div>
              
              <div class="social-login">
                <el-button
                  type="default"
                  circle
                  size="large"
                  @click="handleSSOLogin('ldap')"
                >
                  <el-icon><UserFilled /></el-icon>
                </el-button>
                
                <el-button
                  type="default"
                  circle
                  size="large"
                  @click="handleSSOLogin('ad')"
                >
                  <el-icon><OfficeBuilding /></el-icon>
                </el-button>
              </div>
            </div>
          </el-form>
          
          <!-- 底部信息 -->
          <div class="form-footer">
            <p>
              还没有账号？
              <el-button type="text" @click="handleRegister">
                联系管理员注册
              </el-button>
            </p>
            <p class="copyright">
              © 2026 换热器监测系统 v{{ appVersion }}
            </p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 忘记密码对话框 -->
    <el-dialog
      v-model="forgotPasswordDialog.visible"
      title="重置密码"
      width="400px"
      :before-close="handleForgotPasswordClose"
    >
      <el-form
        ref="forgotPasswordFormRef"
        :model="forgotPasswordDialog.form"
        :rules="forgotPasswordDialog.rules"
        label-width="80px"
      >
        <el-form-item label="邮箱" prop="email">
          <el-input
            v-model="forgotPasswordDialog.form.email"
            placeholder="请输入注册邮箱"
          />
        </el-form-item>
        
        <el-form-item label="验证码" prop="captcha" v-if="forgotPasswordDialog.showCaptcha">
          <div class="dialog-captcha">
            <el-input
              v-model="forgotPasswordDialog.form.captcha"
              placeholder="请输入验证码"
            />
            <el-button
              type="primary"
              :loading="forgotPasswordDialog.captchaLoading"
              @click="sendResetCaptcha"
            >
              {{ forgotPasswordDialog.captchaText }}
            </el-button>
          </div>
        </el-form-item>
      </el-form>
      
      <template #footer>
        <span class="dialog-footer">
          <el-button @click="handleForgotPasswordClose">取消</el-button>
          <el-button
            type="primary"
            :loading="forgotPasswordDialog.submitting"
            @click="handleResetPasswordSubmit"
          >
            发送重置邮件
          </el-button>
        </span>
      </template>
    </el-dialog>
  </div>
</template>

<script setup>
import { ref, reactive, computed, onMounted, onUnmounted } from 'vue'
import { useRouter } from 'vue-router'
import { ElMessage, ElMessageBox } from 'element-plus'
import { 
  User, 
  Lock, 
  Key, 
  Picture,
  Monitor,
  TrendCharts,
  Bell,
  UserFilled,
  OfficeBuilding
} from '@element-plus/icons-vue'
import { useAuthStore } from '@/stores/auth'
import { isValidEmail } from '@/utils/validator'
import { debounce } from '@/utils/debounce-throttle'

// 路由和Store
const router = useRouter()
const authStore = useAuthStore()

// 表单引用
const loginFormRef = ref(null)
const forgotPasswordFormRef = ref(null)

// 响应式数据
const loading = ref(false)
const errorMessage = ref('')
const showCaptcha = ref(false)
const captchaImage = ref('')
const loginAttempts = ref(0)

// 登录表单数据
const loginForm = reactive({
  username: '',
  password: '',
  captcha: '',
  rememberMe: false
})

// 忘记密码对话框数据
const forgotPasswordDialog = reactive({
  visible: false,
  submitting: false,
  captchaLoading: false,
  captchaText: '获取验证码',
  showCaptcha: false,
  countdown: 0,
  form: {
    email: '',
    captcha: ''
  },
  rules: {
    email: [
      { required: true, message: '请输入邮箱地址', trigger: 'blur' },
      { validator: validateEmail, trigger: 'blur' }
    ],
    captcha: [
      { required: true, message: '请输入验证码', trigger: 'blur' }
    ]
  }
})

// 验证规则
const loginRules = reactive({
  username: [
    { required: true, message: '请输入用户名', trigger: 'blur' },
    { min: 3, max: 20, message: '用户名长度为3-20个字符', trigger: 'blur' }
  ],
  password: [
    { required: true, message: '请输入密码', trigger: 'blur' },
    { min: 6, max: 32, message: '密码长度为6-32个字符', trigger: 'blur' }
  ],
  captcha: [
    { required: true, message: '请输入验证码', trigger: 'blur' },
    { len: 4, message: '验证码长度为4个字符', trigger: 'blur' }
  ]
})

// 计算属性
const appVersion = computed(() => {
  return import.meta.env.VITE_APP_VERSION || '1.0.0'
})

// 方法
// 邮箱验证
function validateEmail(rule, value, callback) {
  if (!value) {
    callback(new Error('请输入邮箱地址'))
  } else if (!isValidEmail(value)) {
    callback(new Error('请输入有效的邮箱地址'))
  } else {
    callback()
  }
}

// 处理登录
const handleLogin = debounce(async () => {
  if (!loginFormRef.value) return
  
  // 表单验证
  try {
    await loginFormRef.value.validate()
  } catch (error) {
    console.log('表单验证失败:', error)
    return
  }
  
  // 开始登录
  loading.value = true
  errorMessage.value = ''
  
  try {
    const credentials = {
      username: loginForm.username.trim(),
      password: loginForm.password
    }
    
    // 如果需要验证码
    if (showCaptcha.value) {
      credentials.captcha = loginForm.captcha
    }
    
    // 调用登录
    const result = await authStore.login(credentials)
    
    if (result.success) {
      // 登录成功
      ElMessage.success({
        message: `欢迎回来，${result.user.displayName}！`,
        duration: 2000
      })
      
      // 跳转到目标页面
      router.push(result.redirect)
    } else {
      // 登录失败
      errorMessage.value = result.error
      loginAttempts.value++
      
      // 连续失败3次显示验证码
      if (loginAttempts.value >= 3 && !showCaptcha.value) {
        showCaptcha.value = true
        refreshCaptcha()
      }
    }
  } catch (error) {
    console.error('登录异常:', error)
    errorMessage.value = error.message || '登录失败，请稍后重试'
    loginAttempts.value++
  } finally {
    loading.value = false
  }
}, 300)

// 刷新验证码
function refreshCaptcha() {
  // TODO: 实现验证码获取逻辑
  captchaImage.value = `data:image/svg+xml;base64,...` // 示例
}

// 处理忘记密码
function handleForgotPassword() {
  forgotPasswordDialog.visible = true
  forgotPasswordDialog.form.email = ''
  forgotPasswordDialog.form.captcha = ''
}

// 关闭忘记密码对话框
function handleForgotPasswordClose() {
  if (forgotPasswordDialog.submitting) {
    ElMessageBox.confirm('正在发送重置邮件，确定要关闭吗？', '提示', {
      confirmButtonText: '确定',
      cancelButtonText: '取消',
      type: 'warning'
    }).then(() => {
      forgotPasswordDialog.visible = false
    })
  } else {
    forgotPasswordDialog.visible = false
  }
}

// 发送重置验证码
async function sendResetCaptcha() {
  if (!forgotPasswordDialog.form.email) {
    ElMessage.warning('请输入邮箱地址')
    return
  }
  
  if (!isValidEmail(forgotPasswordDialog.form.email)) {
    ElMessage.warning('请输入有效的邮箱地址')
    return
  }
  
  forgotPasswordDialog.captchaLoading = true
  
  try {
    // TODO: 调用发送验证码API
    await new Promise(resolve => setTimeout(resolve, 1000))
    
    ElMessage.success('验证码已发送到您的邮箱')
    
    // 开始倒计时
    forgotPasswordDialog.countdown = 60
    forgotPasswordDialog.captchaText = `${forgotPasswordDialog.countdown}秒后重试`
    
    const timer = setInterval(() => {
      forgotPasswordDialog.countdown--
      forgotPasswordDialog.captchaText = `${forgotPasswordDialog.countdown}秒后重试`
      
      if (forgotPasswordDialog.countdown <= 0) {
        clearInterval(timer)
        forgotPasswordDialog.captchaText = '获取验证码'
        forgotPasswordDialog.captchaLoading = false
      }
    }, 1000)
    
  } catch (error) {
    ElMessage.error('发送验证码失败: ' + error.message)
    forgotPasswordDialog.captchaLoading = false
  }
}

// 提交重置密码请求
async function handleResetPasswordSubmit() {
  if (!forgotPasswordFormRef.value) return
  
  try {
    await forgotPasswordFormRef.value.validate()
  } catch (error) {
    console.log('表单验证失败:', error)
    return
  }
  
  forgotPasswordDialog.submitting = true
  
  try {
    // TODO: 调用重置密码API
    await new Promise(resolve => setTimeout(resolve, 1500))
    
    ElMessage.success('重置密码邮件已发送，请查收您的邮箱')
    forgotPasswordDialog.visible = false
    
  } catch (error) {
    ElMessage.error('重置密码失败: ' + error.message)
  } finally {
    forgotPasswordDialog.submitting = false
  }
}

// 处理SSO登录
function handleSSOLogin(type) {
  ElMessage.info(`正在跳转到${type}登录...`)
  // TODO: 实现SSO登录逻辑
}

// 处理注册
function handleRegister() {
  ElMessage.info('请联系系统管理员进行账号注册')
}

// 键盘事件处理
function handleKeyDown(event) {
  if (event.key === 'Enter' && !loading.value) {
    handleLogin()
  }
}

// 生命周期
onMounted(() => {
  // 恢复记住的用户名
  const savedUsername = localStorage.getItem('remembered_username')
  if (savedUsername) {
    loginForm.username = savedUsername
    loginForm.rememberMe = true
  }
  
  // 监听键盘事件
  window.addEventListener('keydown', handleKeyDown)
})

onUnmounted(() => {
  // 保存记住的用户名
  if (loginForm.rememberMe && loginForm.username) {
    localStorage.setItem('remembered_username', loginForm.username)
  } else {
    localStorage.removeItem('remembered_username')
  }
  
  // 移除键盘事件监听
  window.removeEventListener('keydown', handleKeyDown)
})
</script>

<style scoped lang="scss">
@import '@/assets/styles/variables.scss';

.login-container {
  width: 100vw;
  height: 100vh;
  overflow: hidden;
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
}

.login-background {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 1;
  
  .background-pattern {
    position: absolute;
    width: 100%;
    height: 100%;
    background: 
      radial-gradient(circle at 20% 80%, rgba(26, 35, 126, 0.1) 0%, transparent 50%),
      radial-gradient(circle at 80% 20%, rgba(0, 188, 212, 0.1) 0%, transparent 50%);
    background-size: 400% 400%;
    animation: gradientMove 20s ease infinite;
  }
  
  .background-overlay {
    position: absolute;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(245, 245, 245, 0.98) 100%);
  }
}

@keyframes gradientMove {
  0%, 100% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
}

.login-main {
  position: relative;
  z-index: 2;
  width: 100%;
  max-width: 1200px;
  height: 700px;
  background: white;
  border-radius: 20px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
  display: flex;
  overflow: hidden;
}

.login-brand {
  flex: 1;
  padding: 60px 40px;
  background: linear-gradient(135deg, color(primary) 0%, color(primary-dark) 100%);
  color: white;
  display: flex;
  flex-direction: column;
  
  .brand-logo {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 40px;
    
    .logo-icon {
      width: 40px;
      height: 40px;
      color: white;
    }
    
    .brand-name {
      font-size: 24px;
      font-weight: 600;
    }
  }
  
  .brand-slogan {
    flex: 1;
    margin-bottom: 60px;
    
    h1 {
      font-size: 36px;
      font-weight: 700;
      line-height: 1.3;
      margin-bottom: 16px;
    }
    
    p {
      font-size: 18px;
      opacity: 0.9;
    }
  }
  
  .brand-features {
    .feature-item {
      display: flex;
      align-items: flex-start;
      gap: 16px;
      margin-bottom: 30px;
      
      .feature-icon {
        width: 48px;
        height: 48px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        
        .el-icon {
          font-size: 24px;
          color: white;
        }
      }
      
      .feature-content {
        flex: 1;
        
        h3 {
          font-size: 18px;
          font-weight: 600;
          margin-bottom: 6px;
        }
        
        p {
          font-size: 14px;
          opacity: 0.8;
          line-height: 1.5;
        }
      }
    }
  }
}

.login-form-container {
  flex: 1;
  padding: 60px 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  
  .form-wrapper {
    width: 100%;
    max-width: 400px;
  }
  
  .form-header {
    text-align: center;
    margin-bottom: 40px;
    
    h2 {
      font-size: 28px;
      font-weight: 600;
      color: color(gray-900);
      margin-bottom: 8px;
    }
    
    p {
      font-size: 16px;
      color: color(gray-600);
    }
  }
  
  .login-form {
    .captcha-container {
      display: flex;
      gap: 12px;
      align-items: center;
      
      .captcha-input {
        flex: 1;
      }
      
      .captcha-image {
        width: 120px;
        height: 40px;
        border: 1px solid color(gray-300);
        border-radius: 4px;
        cursor: pointer;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        background: color(gray-100);
        
        img {
          width: 100%;
          height: 100%;
          object-fit: cover;
        }
        
        .captcha-placeholder {
          .el-icon {
            font-size: 24px;
            color: color(gray-500);
          }
        }
        
        &:hover {
          border-color: color(primary);
        }
      }
    }
    
    .form-options {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      
      .remember-me {
        :deep(.el-checkbox__label) {
          color: color(gray-600);
        }
      }
      
      .forgot-password {
        .el-button {
          padding: 0;
          font-size: 14px;
        }
      }
    }
    
    .login-button {
      width: 100%;
      font-size: 16px;
      font-weight: 500;
      height: 48px;
      border-radius: 8px;
      margin-top: 10px;
    }
    
    .error-message {
      margin-top: 20px;
      
      :deep(.el-alert) {
        border-radius: 8px;
      }
    }
    
    .alternative-login {
      margin-top: 30px;
      
      .divider {
        position: relative;
        text-align: center;
        margin-bottom: 20px;
        
        span {
          display: inline-block;
          padding: 0 20px;
          background: white;
          color: color(gray-500);
          font-size: 14px;
          position: relative;
          z-index: 2;
        }
        
        &::before {
          content: '';
          position: absolute;
          top: 50%;
          left: 0;
          right: 0;
          height: 1px;
          background: color(gray-300);
          z-index: 1;
        }
      }
      
      .social-login {
        display: flex;
        justify-content: center;
        gap: 20px;
        
        .el-button {
          width: 48px;
          height: 48px;
          
          .el-icon {
            font-size: 20px;
          }
          
          &:hover {
            border-color: color(primary);
            color: color(primary);
          }
        }
      }
    }
  }
  
  .form-footer {
    margin-top: 40px;
    text-align: center;
    
    p {
      color: color(gray-600);
      font-size: 14px;
      margin-bottom: 8px;
      
      .el-button {
        padding: 0;
        font-size: 14px;
      }
    }
    
    .copyright {
      font-size: 12px;
      color: color(gray-400);
      margin-top: 20px;
    }
  }
}

.dialog-captcha {
  display: flex;
  gap: 10px;
  
  .el-input {
    flex: 1;
  }
  
  .el-button {
    white-space: nowrap;
  }
}
</style>
```

**步骤2：创建路由配置**
```javascript
// src/router/index.js - 添加登录路由
import { createRouter, createWebHistory } from 'vue-router'

const routes = [
  {
    path: '/login',
    name: 'login',
    component: () => import('@/views/Login.vue'),
    meta: {
      title: '登录',
      requiresAuth: false, // 不需要认证
      hideLayout: true // 隐藏布局
    }
  },
  // ... 其他路由
]

const router = createRouter({
  history: createWebHistory(),
  routes
})

export default router
```

#### 验收条件
1. **UI界面验证**：
   - 登录页面UI符合设计规范
   - 响应式布局正常
   - 视觉效果美观

2. **功能完整性验证**：
   - 表单验证提示清晰
   - 登录成功跳转到主页
   - 错误处理完善

3. **用户体验验证**：
   - 加载状态显示正确
   - 键盘导航支持完善
   - 错误提示友好

4. **集成验证**：
   - 与认证Store正确集成
   - API调用错误处理完善
   - 状态管理正确

#### 产出物清单
- ✓ src/views/Login.vue（登录页面组件）
- ✓ 完整的登录表单和验证逻辑
- ✓ 忘记密码功能
- ✓ SSO登录支持（基础框架）
- ✓ 美观的UI设计和响应式布局

---

### T2.3.3 实现路由权限守卫

#### 任务描述
1. **配置Vue Router全局守卫**：
   - 实现路由导航守卫
   - 检查用户认证状态
   - 处理未认证访问

2. **实现基于角色的路由控制**：
   - 路由元信息配置权限
   - 角色权限检查逻辑
   - 无权限访问处理

3. **实现基于权限的路由控制**：
   - 细粒度权限控制
   - 动态路由加载
   - 权限变更处理

4. **实现登录过期处理**：
   - Token过期检测
   - 自动刷新Token
   - 过期重定向逻辑

#### 技术细节与实现步骤

**步骤1：创建路由权限守卫**
```javascript
// src/router/guards.js
/**
 * 路由权限守卫
 */

import { ElMessage, ElNotification } from 'element-plus'
import { useAuthStore } from '@/stores/auth'

/**
 * 全局前置守卫
 */
export async function beforeEachGuard(to, from, next) {
  const authStore = useAuthStore()
  
  // 设置页面标题
  setDocumentTitle(to)
  
  // 检查路由是否需要认证
  if (to.meta.requiresAuth === false) {
    // 不需要认证的路由，直接放行
    return next()
  }
  
  // 初始化认证状态（如果未初始化）
  if (!authStore.isInitialized) {
    try {
      await authStore.initializeAuth()
    } catch (error) {
      console.error('初始化认证状态失败:', error)
    }
  }
  
  // 检查是否已认证
  if (!authStore.isAuthenticated) {
    // 未认证，重定向到登录页
    return redirectToLogin(to, next)
  }
  
  // 检查Token是否即将过期
  if (authStore.isTokenExpiringSoon) {
    try {
      await authStore.refreshAccessToken()
    } catch (error) {
      console.warn('刷新Token失败，重新登录:', error)
      return redirectToLogin(to, next)
    }
  }
  
  // 检查角色权限
  if (to.meta.roles && !checkRolePermission(authStore, to.meta.roles)) {
    return redirectToNoPermission(to, next)
  }
  
  // 检查特定权限
  if (to.meta.permissions && !checkPermission(authStore, to.meta.permissions)) {
    return redirectToNoPermission(to, next)
  }
  
  // 检查是否可以访问换热器
  if (to.params.heatExchangerId && !checkHeatExchangerAccess(authStore, to.params.heatExchangerId)) {
    return redirectToNoPermission(to, next, '您没有权限访问此换热器')
  }
  
  // 所有检查通过，允许导航
  next()
}

/**
 * 全局后置钩子
 */
export function afterEachGuard(to, from) {
  // 记录页面访问
  logPageAccess(to, from)
  
  // 清除路由错误状态
  clearRouteErrors()
}

/**
 * 设置文档标题
 */
function setDocumentTitle(route) {
  const title = route.meta.title || '换热器监测系统'
  const appName = import.meta.env.VITE_APP_TITLE || '换热器监测系统'
  
  document.title = `${title} - ${appName}`
}

/**
 * 重定向到登录页
 */
function redirectToLogin(to, next) {
  const authStore = useAuthStore()
  
  // 保存重定向路径（当前尝试访问的页面）
  if (to.path !== '/login') {
    authStore.setRedirectPath(to.fullPath)
  }
  
  // 显示登录提示
  if (to.path !== '/login' && !to.meta.suppressLoginPrompt) {
    ElNotification({
      title: '需要登录',
      message: '请先登录以访问此页面',
      type: 'warning',
      duration: 3000
    })
  }
  
  // 跳转到登录页
  next('/login')
}

/**
 * 重定向到无权限页面
 */
function redirectToNoPermission(to, next, customMessage = null) {
  const message = customMessage || '您没有权限访问此页面'
  
  ElNotification({
    title: '权限不足',
    message: message,
    type: 'error',
    duration: 5000
  })
  
  // 记录权限拒绝日志
  logPermissionDenied(to)
  
  // 根据用户角色重定向到合适的页面
  const authStore = useAuthStore()
  
  if (authStore.userRole === 'operator') {
    next('/dashboard')
  } else if (authStore.userRole === 'engineer') {
    next('/heat-exchangers')
  } else {
    next('/403') // 无权限页面
  }
}

/**
 * 检查角色权限
 */
function checkRolePermission(authStore, requiredRoles) {
  if (!requiredRoles || requiredRoles.length === 0) {
    return true
  }
  
  const userRole = authStore.userRole
  return requiredRoles.includes(userRole)
}

/**
 * 检查权限
 */
function checkPermission(authStore, requiredPermissions) {
  if (!requiredPermissions || requiredPermissions.length === 0) {
    return true
  }
  
  // 检查是否有任意权限
  if (Array.isArray(requiredPermissions)) {
    return authStore.hasAnyPermission(requiredPermissions)
  }
  
  // 检查单个权限
  return authStore.hasPermission(requiredPermissions)
}

/**
 * 检查换热器访问权限
 */
function checkHeatExchangerAccess(authStore, heatExchangerId) {
  return authStore.canViewHeatExchanger(heatExchangerId)
}

/**
 * 记录页面访问
 */
function logPageAccess(to, from) {
  const authStore = useAuthStore()
  
  if (authStore.isAuthenticated && to.meta.logAccess !== false) {
    const accessLog = {
      timestamp: new Date().toISOString(),
      from: from.path,
      to: to.path,
      user: authStore.user?.username,
      userAgent: navigator.userAgent
    }
    
    // 发送到服务器（可选）
    // sendAccessLog(accessLog)
    
    // 本地存储（用于调试）
    const accessLogs = JSON.parse(localStorage.getItem('page_access_logs') || '[]')
    accessLogs.unshift(accessLog)
    
    if (accessLogs.length > 100) {
      accessLogs.pop()
    }
    
    localStorage.setItem('page_access_logs', JSON.stringify(accessLogs))
  }
}

/**
 * 记录权限拒绝
 */
function logPermissionDenied(route) {
  const authStore = useAuthStore()
  
  const deniedLog = {
    timestamp: new Date().toISOString(),
    route: route.path,
    user: authStore.user?.username,
    requiredRoles: route.meta.roles,
    requiredPermissions: route.meta.permissions,
    userRole: authStore.userRole
  }
  
  // 发送到服务器（可选）
  // sendPermissionDeniedLog(deniedLog)
  
  // 本地存储（用于调试）
  const deniedLogs = JSON.parse(localStorage.getItem('permission_denied_logs') || '[]')
  deniedLogs.unshift(deniedLog)
  
  if (deniedLogs.length > 50) {
    deniedLogs.pop()
  }
  
  localStorage.setItem('permission_denied_logs', JSON.stringify(deniedLogs))
}

/**
 * 清除路由错误状态
 */
function clearRouteErrors() {
  // 可以在这里清除全局的错误状态
}
```

**步骤2：配置路由权限元信息**
```javascript
// src/router/routes.js
/**
 * 路由定义
 */

import { PERMISSIONS } from '@/models/user'

export const routes = [
  {
    path: '/login',
    name: 'login',
    component: () => import('@/views/Login.vue'),
    meta: {
      title: '登录',
      requiresAuth: false,
      hideLayout: true,
      suppressLoginPrompt: true
    }
  },
  
  {
    path: '/',
    redirect: '/dashboard'
  },
  
  {
    path: '/dashboard',
    name: 'dashboard',
    component: () => import('@/views/Dashboard.vue'),
    meta: {
      title: '仪表盘',
      requiresAuth: true,
      roles: ['operator', 'engineer', 'admin'],
      permissions: [PERMISSIONS.VIEW_DASHBOARD],
      icon: 'dashboard',
      breadcrumb: ['首页']
    }
  },
  
  {
    path: '/heat-exchangers',
    name: 'heat-exchangers',
    component: () => import('@/views/HeatExchangers.vue'),
    meta: {
      title: '换热器列表',
      requiresAuth: true,
      roles: ['operator', 'engineer', 'admin'],
      permissions: [PERMISSIONS.VIEW_HEAT_EXCHANGERS],
      icon: 'heat-exchanger',
      breadcrumb: ['换热器管理']
    }
  },
  
  {
    path: '/heat-exchangers/:id',
    name: 'heat-exchanger-detail',
    component: () => import('@/views/HeatExchangerDetail.vue'),
    meta: {
      title: '换热器详情',
      requiresAuth: true,
      roles: ['operator', 'engineer', 'admin'],
      permissions: [PERMISSIONS.VIEW_HEAT_EXCHANGERS],
      icon: 'detail',
      breadcrumb: ['换热器管理', '详情']
    },
    props: true
  },
  
  {
    path: '/heat-exchangers/:heatExchangerId/sections/:sectionNumber',
    name: 'section-detail',
    component: () => import('@/views/SectionDetail.vue'),
    meta: {
      title: '管段详情',
      requiresAuth: true,
      roles: ['operator', 'engineer', 'admin'],
      permissions: [PERMISSIONS.VIEW_HEAT_EXCHANGERS],
      icon: 'section',
      breadcrumb: ['换热器管理', '管段详情']
    },
    props: true
  },
  
  {
    path: '/alerts',
    name: 'alerts',
    component: () => import('@/views/Alerts.vue'),
    meta: {
      title: '报警管理',
      requiresAuth: true,
      roles: ['operator', 'engineer', 'admin'],
      permissions: [PERMISSIONS.VIEW_ALERTS],
      icon: 'alert',
      breadcrumb: ['报警管理']
    }
  },
  
  {
    path: '/reports',
    name: 'reports',
    component: () => import('@/views/Reports.vue'),
    meta: {
      title: '报表分析',
      requiresAuth: true,
      roles: ['engineer', 'admin'],
      permissions: [PERMISSIONS.VIEW_REPORTS],
      icon: 'report',
      breadcrumb: ['报表分析']
    }
  },
  
  {
    path: '/system',
    name: 'system',
    component: () => import('@/views/System.vue'),
    meta: {
      title: '系统管理',
      requiresAuth: true,
      roles: ['admin'],
      permissions: [PERMISSIONS.MANAGE_SYSTEM_SETTINGS],
      icon: 'system',
      breadcrumb: ['系统管理']
    },
    children: [
      {
        path: 'users',
        name: 'user-management',
        component: () => import('@/views/system/UserManagement.vue'),
        meta: {
          title: '用户管理',
          roles: ['admin'],
          permissions: [PERMISSIONS.MANAGE_USERS],
          icon: 'user',
          breadcrumb: ['系统管理', '用户管理']
        }
      },
      {
        path: 'logs',
        name: 'system-logs',
        component: () => import('@/views/system/SystemLogs.vue'),
        meta: {
          title: '系统日志',
          roles: ['admin'],
          permissions: [PERMISSIONS.VIEW_SYSTEM_LOGS],
          icon: 'log',
          breadcrumb: ['系统管理', '系统日志']
        }
      },
      {
        path: 'audit-logs',
        name: 'audit-logs',
        component: () => import('@/views/system/AuditLogs.vue'),
        meta: {
          title: '审计日志',
          roles: ['admin'],
          permissions: [PERMISSIONS.VIEW_AUDIT_LOGS],
          icon: 'audit',
          breadcrumb: ['系统管理', '审计日志']
        }
      }
    ]
  },
  
  {
    path: '/profile',
    name: 'profile',
    component: () => import('@/views/Profile.vue'),
    meta: {
      title: '个人中心',
      requiresAuth: true,
      roles: ['operator', 'engineer', 'admin'],
      icon: 'profile',
      breadcrumb: ['个人中心']
    }
  },
  
  {
    path: '/403',
    name: 'forbidden',
    component: () => import('@/views/error/403.vue'),
    meta: {
      title: '无权限访问',
      requiresAuth: true,
      hideLayout: false
    }
  },
  
  {
    path: '/404',
    name: 'not-found',
    component: () => import('@/views/error/404.vue'),
    meta: {
      title: '页面不存在',
      requiresAuth: false,
      hideLayout: false
    }
  },
  
  {
    path: '/:pathMatch(.*)*',
    redirect: '/404'
  }
]
```

**步骤3：集成路由守卫到Vue Router**
```javascript
// src/router/index.js
import { createRouter, createWebHistory } from 'vue-router'
import { routes } from './routes'
import { beforeEachGuard, afterEachGuard } from './guards'

// 创建路由实例
const router = createRouter({
  history: createWebHistory(),
  routes,
  
  // 滚动行为
  scrollBehavior(to, from, savedPosition) {
    if (savedPosition) {
      return savedPosition
    } else {
      return { top: 0 }
    }
  }
})

// 注册全局前置守卫
router.beforeEach(beforeEachGuard)

// 注册全局后置钩子
router.afterEach(afterEachGuard)

// 导出路由实例
export default router

// 导出路由工具函数
export function resetRouter() {
  const newRouter = createRouter({
    history: createWebHistory(),
    routes
  })
  
  router.matcher = newRouter.matcher
}

/**
 * 动态添加路由（用于权限动态加载）
 */
export function addRoutes(routes) {
  routes.forEach(route => {
    router.addRoute(route)
  })
}

/**
 * 根据用户权限过滤路由
 */
export function filterRoutesByPermission(userPermissions) {
  return routes.filter(route => {
    // 检查路由是否需要有权限
    if (!route.meta || !route.meta.permissions) {
      return true
    }
    
    // 检查用户是否有权限
    const requiredPermissions = route.meta.permissions
    if (Array.isArray(requiredPermissions)) {
      return requiredPermissions.some(permission => 
        userPermissions.includes(permission)
      )
    }
    
    return userPermissions.includes(requiredPermissions)
  })
}
```

**步骤4：创建错误页面组件**
```vue
<!-- src/views/error/403.vue -->
<template>
  <div class="error-page">
    <div class="error-container">
      <div class="error-icon">
        <el-icon><Lock /></el-icon>
      </div>
      <h1 class="error-title">403</h1>
      <h2 class="error-subtitle">权限不足</h2>
      <p class="error-description">
        抱歉，您没有权限访问此页面。请联系管理员获取权限。
      </p>
      <div class="error-actions">
        <el-button type="primary" @click="goBack">返回上一页</el-button>
        <el-button @click="goHome">返回首页</el-button>
        <el-button type="text" @click="goLogin" v-if="!isAuthenticated">
          重新登录
        </el-button>
      </div>
      <div class="error-details" v-if="showDetails">
        <p><strong>请求路径：</strong> {{ currentPath }}</p>
        <p><strong>用户角色：</strong> {{ userRole }}</p>
        <p><strong>需要权限：</strong> {{ requiredPermissions }}</p>
      </div>
    </div>
  </div>
</template>

<script setup>
import { computed } from 'vue'
import { useRouter, useRoute } from 'vue-router'
import { useAuthStore } from '@/stores/auth'
import { Lock } from '@element-plus/icons-vue'

const router = useRouter()
const route = useRoute()
const authStore = useAuthStore()

const isAuthenticated = computed(() => authStore.isAuthenticated)
const userRole = computed(() => authStore.userRole)
const currentPath = computed(() => route.fullPath)
const requiredPermissions = computed(() => route.meta?.permissions || '无特定权限')
const showDetails = computed(() => import.meta.env.DEV) // 只在开发环境显示详情

function goBack() {
  router.go(-1)
}

function goHome() {
  router.push('/dashboard')
}

function goLogin() {
  router.push('/login')
}
</script>

<style scoped lang="scss">
@import '@/assets/styles/variables.scss';

.error-page {
  width: 100%;
  height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(135deg, color(gray-50) 0%, white 100%);
}

.error-container {
  text-align: center;
  max-width: 500px;
  padding: 40px;
  background: white;
  border-radius: 16px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
  
  .error-icon {
    width: 80px;
    height: 80px;
    margin: 0 auto 20px;
    background: linear-gradient(135deg, color(error) 0%, lighten(color(error), 10%) 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    
    .el-icon {
      font-size: 40px;
      color: white;
    }
  }
  
  .error-title {
    font-size: 72px;
    font-weight: 700;
    color: color(gray-900);
    margin: 0;
    line-height: 1;
  }
  
  .error-subtitle {
    font-size: 24px;
    font-weight: 600;
    color: color(gray-700);
    margin: 10px 0;
  }
  
  .error-description {
    font-size: 16px;
    color: color(gray-600);
    line-height: 1.6;
    margin: 20px 0 30px;
  }
  
  .error-actions {
    display: flex;
    gap: 12px;
    justify-content: center;
    margin-bottom: 30px;
    
    .el-button {
      min-width: 120px;
    }
  }
  
  .error-details {
    text-align: left;
    padding: 20px;
    background: color(gray-100);
    border-radius: 8px;
    border-left: 4px solid color(error);
    
    p {
      margin: 8px 0;
      font-size: 14px;
      color: color(gray-700);
      
      strong {
        color: color(gray-900);
      }
    }
  }
}
</style>
```

#### 验收条件
1. **路由守卫验证**：
   - 未认证用户访问受限路由跳转登录页
   - 已认证用户访问登录页重定向到主页
   - Token过期能自动刷新或重定向

2. **权限控制验证**：
   - 角色权限控制正确
   - 细粒度权限控制有效
   - 无权限访问正确处理

3. **错误处理验证**：
   - 403页面显示正确
   - 错误信息友好
   - 导航恢复功能正常

4. **性能验证**：
   - 路由守卫不造成明显性能影响
   - 动态路由加载正常
   - 状态管理高效

#### 产出物清单
- ✓ src/router/guards.js（路由权限守卫）
- ✓ src/router/routes.js（路由配置）
- ✓ src/views/error/403.vue（无权限页面）
- ✓ src/views/error/404.vue（页面不存在）
- ✓ 完整的路由权限控制系统
- ✓ 动态路由加载机制
- ✓ 详细的权限日志记录

---

## 模块完成标准

### 总体验收条件
1. **认证系统完整**：
   - 登录、注销功能正常工作
   - Token管理完善
   - 用户信息能正确获取和更新

2. **权限控制完善**：
   - 路由权限守卫工作正常
   - 角色权限映射准确
   - 细粒度权限控制有效

3. **用户体验优秀**：
   - 登录页面美观易用
   - 错误提示友好明确
   - 导航流畅无卡顿

4. **安全性可靠**：
   - Token安全存储
   - 权限检查严格
   - 登录历史记录完整

### 产出物总览
- ✓ 完整的用户认证和授权系统
- ✓ 美观的登录页面组件
- ✓ 严格的路由权限控制
- ✓ 完善的错误处理机制
- ✓ 详细的日志记录功能

### 下一模块准备
完成本模块后，项目已具备：
1. 完整的用户认证系统
2. 严格的权限控制机制
3. 美观的登录界面
4. 可靠的安全保障

可以进入下一模块：布局导航模块开发